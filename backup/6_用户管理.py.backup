# pages/user_management.py
"""
ç”¨æˆ·ç®¡ç†æ¨¡å—
åŠŸèƒ½ï¼šç”¨æˆ·çš„å¢åˆ æ”¹æŸ¥ã€æƒé™ç®¡ç†ã€æ“ä½œæ—¥å¿—æŸ¥çœ‹
æƒé™ï¼šä»…è¶…çº§ç®¡ç†å‘˜å¯è®¿é—®
"""

import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
from utils.auth import (
    has_permission, get_all_users, create_user, update_user_status,
    get_user_activity_log, get_all_roles, validate_password_strength,
    update_user_password, log_user_action
)
from utils.database import execute_query
import logging

def show():
    """ç”¨æˆ·ç®¡ç†ä¸»é¡µé¢"""
    st.title("ğŸ‘¥ ç”¨æˆ·ç®¡ç†")
    
    # æƒé™æ£€æŸ¥
    if not has_permission('manage_users'):
        st.error("âŒ æƒé™ä¸è¶³ï¼šä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®ç”¨æˆ·ç®¡ç†åŠŸèƒ½")
        return
    
    # æ·»åŠ è‡ªå®šä¹‰æ ·å¼
    st.markdown("""
    <style>
        .user-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 10px 0;
            border-left: 4px solid #1f77b4;
        }
        .status-active { color: #4caf50; font-weight: bold; }
        .status-inactive { color: #f44336; font-weight: bold; }
        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin: 2px;
        }
        .role-admin { background: #e3f2fd; color: #1976d2; }
        .role-manager { background: #f3e5f5; color: #7b1fa2; }
        .role-technician { background: #e8f5e9; color: #388e3c; }
        .role-operator { background: #fff3e0; color: #f57c00; }
    </style>
    """, unsafe_allow_html=True)
    
    # é¡µé¢å¯¼èˆª
    tab1, tab2, tab3, tab4 = st.tabs([
        "ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨", "â• æ–°å¢ç”¨æˆ·", "ğŸ” è§’è‰²æƒé™", "ğŸ“Š æ“ä½œæ—¥å¿—"
    ])
    
    with tab1:
        show_user_list()
    
    with tab2:
        show_create_user()
    
    with tab3:
        show_role_management()
    
    with tab4:
        show_activity_logs()

def show_user_list():
    """æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨"""
    st.markdown("### ğŸ‘¥ ç³»ç»Ÿç”¨æˆ·åˆ—è¡¨")
    
    # ç­›é€‰æ¡ä»¶
    col1, col2, col3, col4 = st.columns([3, 2, 2, 1])
    with col1:
        search_term = st.text_input("ğŸ” æœç´¢ç”¨æˆ·", placeholder="è¾“å…¥ç”¨æˆ·åæˆ–å§“å", key="user_search")
    with col2:
        role_filter = st.selectbox(
            "è§’è‰²ç­›é€‰",
            ["å…¨éƒ¨"] + [r['role_name'] for r in get_all_roles()],
            key="role_filter"
        )
    with col3:
        status_filter = st.selectbox("çŠ¶æ€ç­›é€‰", ["å…¨éƒ¨", "å¯ç”¨", "ç¦ç”¨"], key="status_filter")
    with col4:
        st.markdown("<br>", unsafe_allow_html=True)
        if st.button("ğŸ”„ åˆ·æ–°", key="refresh_users"):
            st.rerun()
    
    # è·å–ç”¨æˆ·åˆ—è¡¨
    users = get_all_users()
    
    # åº”ç”¨ç­›é€‰
    if search_term:
        users = [u for u in users if search_term.lower() in u['username'].lower() 
                 or search_term.lower() in u['full_name'].lower()]
    if role_filter != "å…¨éƒ¨":
        users = [u for u in users if u['role_name'] == role_filter]
    if status_filter != "å…¨éƒ¨":
        is_active = status_filter == "å¯ç”¨"
        users = [u for u in users if u['is_active'] == is_active]
    
    # ç»Ÿè®¡ä¿¡æ¯
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("æ€»ç”¨æˆ·æ•°", len(get_all_users()))
    with col2:
        active_users = len([u for u in get_all_users() if u['is_active']])
        st.metric("æ´»è·ƒç”¨æˆ·", active_users)
    with col3:
        st.metric("å½“å‰ç­›é€‰", len(users))
    with col4:
        roles_count = len(get_all_roles())
        st.metric("è§’è‰²æ•°", roles_count)
    
    st.markdown("---")
    
    # æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
    if users:
        # ä½¿ç”¨åˆ—å¸ƒå±€æ˜¾ç¤ºç”¨æˆ·å¡ç‰‡
        for i in range(0, len(users), 2):
            cols = st.columns(2)
            for j in range(2):
                if i + j < len(users):
                    user = users[i + j]
                    with cols[j]:
                        display_user_card(user)
    else:
        st.info("ğŸ˜” æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·")

def display_user_card(user):
    """æ˜¾ç¤ºç”¨æˆ·å¡ç‰‡"""
    status_class = "status-active" if user['is_active'] else "status-inactive"
    status_text = "âœ… å¯ç”¨" if user['is_active'] else "âŒ ç¦ç”¨"
    
    # è§’è‰²æ ·å¼æ˜ å°„
    role_style_map = {
        'è¶…çº§ç®¡ç†å‘˜': 'role-admin',
        'æ¨¡å…·åº“ç®¡ç†å‘˜': 'role-manager',
        'æ¨¡å…·å·¥': 'role-technician',
        'å†²å‹æ“ä½œå·¥': 'role-operator'
    }
    role_class = role_style_map.get(user['role_name'], '')
    
    # ç”¨æˆ·å¡ç‰‡HTML
    card_html = f"""
    <div class="user-card">
        <h4>{user['full_name']}</h4>
        <p><strong>ç”¨æˆ·å:</strong> {user['username']}</p>
        <p><strong>è§’è‰²:</strong> <span class="role-badge {role_class}">{user['role_name']}</span></p>
        <p><strong>çŠ¶æ€:</strong> <span class="{status_class}">{status_text}</span></p>
        <p><strong>é‚®ç®±:</strong> {user.get('email', 'æœªè®¾ç½®')}</p>
        <p><strong>åˆ›å»ºæ—¶é—´:</strong> {user['created_at'].strftime('%Y-%m-%d')}</p>
    </div>
    """
    st.markdown(card_html, unsafe_allow_html=True)
    
    # æ“ä½œæŒ‰é’®
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if user['is_active']:
            if st.button(f"ğŸ”’ ç¦ç”¨", key=f"disable_{user['user_id']}"):
                success, msg = update_user_status(user['user_id'], False)
                if success:
                    st.success(msg)
                    log_user_action('DISABLE_USER', 'users', str(user['user_id']))
                    st.rerun()
                else:
                    st.error(msg)
        else:
            if st.button(f"ğŸ”“ å¯ç”¨", key=f"enable_{user['user_id']}"):
                success, msg = update_user_status(user['user_id'], True)
                if success:
                    st.success(msg)
                    log_user_action('ENABLE_USER', 'users', str(user['user_id']))
                    st.rerun()
                else:
                    st.error(msg)
    
    with col2:
        if st.button(f"âœï¸ ç¼–è¾‘", key=f"edit_{user['user_id']}"):
            st.session_state['edit_user_id'] = user['user_id']
            st.info("ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...")
    
    with col3:
        if st.button(f"ğŸ“Š æ—¥å¿—", key=f"logs_{user['user_id']}"):
            st.session_state['view_user_logs'] = user['user_id']
            st.rerun()

def show_create_user():
    """æ–°å¢ç”¨æˆ·ç•Œé¢"""
    st.markdown("### â• æ–°å¢ç³»ç»Ÿç”¨æˆ·")
    
    # è¯´æ˜ä¿¡æ¯
    st.info("""
    ğŸ’¡ **æç¤º**ï¼š
    - ç”¨æˆ·åç”¨äºç™»å½•ï¼Œåˆ›å»ºåä¸å¯ä¿®æ”¹
    - å¯†ç è¦æ±‚ï¼šè‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—
    - é‚®ç®±ç”¨äºå¯†ç é‡ç½®å’Œç³»ç»Ÿé€šçŸ¥
    """)
    
    with st.form("create_user_form", clear_on_submit=True):
        st.markdown("#### åŸºæœ¬ä¿¡æ¯")
        col1, col2 = st.columns(2)
        
        with col1:
            username = st.text_input(
                "ç”¨æˆ·å *", 
                placeholder="ä¾‹å¦‚: zhangsan",
                help="ç”¨äºç™»å½•çš„å”¯ä¸€æ ‡è¯†ï¼Œåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿"
            )
            full_name = st.text_input(
                "çœŸå®å§“å *",
                placeholder="ä¾‹å¦‚: å¼ ä¸‰"
            )
            email = st.text_input(
                "é‚®ç®±åœ°å€", 
                placeholder="ä¾‹å¦‚: zhangsan@company.com",
                help="ç”¨äºå¯†ç é‡ç½®å’Œé€šçŸ¥"
            )
        
        with col2:
            password = st.text_input(
                "åˆå§‹å¯†ç  *", 
                type="password",
                help="è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—"
            )
            password_confirm = st.text_input(
                "ç¡®è®¤å¯†ç  *", 
                type="password"
            )
            roles = get_all_roles()
            role_id = st.selectbox(
                "ç”¨æˆ·è§’è‰² *",
                options=[(r['role_id'], r['role_name']) for r in roles],
                format_func=lambda x: x[1],
                help="é€‰æ‹©ç”¨æˆ·çš„ç³»ç»Ÿè§’è‰²"
            )[0]
        
        # é¢å¤–é€‰é¡¹
        st.markdown("#### è´¦æˆ·é€‰é¡¹")
        col1, col2 = st.columns(2)
        with col1:
            send_email = st.checkbox("å‘é€æ¬¢è¿é‚®ä»¶", value=True, help="å‘ç”¨æˆ·å‘é€è´¦æˆ·ä¿¡æ¯")
        with col2:
            force_change = st.checkbox("é¦–æ¬¡ç™»å½•ä¿®æ”¹å¯†ç ", value=True, help="è¦æ±‚ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶ä¿®æ”¹å¯†ç ")
        
        # æäº¤æŒ‰é’®
        col1, col2, col3 = st.columns([1, 1, 3])
        with col1:
            submitted = st.form_submit_button("âœ… åˆ›å»ºç”¨æˆ·", type="primary")
        with col2:
            if st.form_submit_button("âŒ å–æ¶ˆ"):
                st.rerun()
        
        if submitted:
            # éªŒè¯è¾“å…¥
            errors = []
            
            # åŸºç¡€éªŒè¯
            if not all([username, full_name, password, password_confirm]):
                errors.append("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ")
            
            # ç”¨æˆ·åæ ¼å¼éªŒè¯
            if username and not username.replace('_', '').isalnum():
                errors.append("ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿")
            
            # å¯†ç éªŒè¯
            if password != password_confirm:
                errors.append("ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´")
            
            if password:
                is_valid, msg = validate_password_strength(password)
                if not is_valid:
                    errors.append(msg)
            
            # é‚®ç®±æ ¼å¼éªŒè¯
            if email and '@' not in email:
                errors.append("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
            
            if errors:
                for error in errors:
                    st.error(f"âŒ {error}")
            else:
                # åˆ›å»ºç”¨æˆ·
                with st.spinner("æ­£åœ¨åˆ›å»ºç”¨æˆ·..."):
                    success, msg = create_user(username, password, full_name, role_id, email)
                    
                if success:
                    st.success(f"âœ… {msg}")
                    st.balloons()
                    
                    # è®°å½•æ“ä½œæ—¥å¿—
                    log_user_action('CREATE_USER', 'users', username, {
                        'full_name': full_name,
                        'role_id': role_id,
                        'email': email
                    })
                    
                    # æ¨¡æ‹Ÿå‘é€é‚®ä»¶
                    if send_email and email:
                        st.info(f"ğŸ“§ æ¬¢è¿é‚®ä»¶å·²å‘é€è‡³ {email}")
                    
                    # å»¶è¿Ÿååˆ·æ–°é¡µé¢
                    import time
                    time.sleep(2)
                    st.rerun()
                else:
                    st.error(f"âŒ {msg}")

def show_role_management():
    """è§’è‰²æƒé™ç®¡ç†ç•Œé¢"""
    st.markdown("### ğŸ” è§’è‰²æƒé™ç®¡ç†")
    
    # è·å–æ‰€æœ‰è§’è‰²
    roles = get_all_roles()
    
    # è§’è‰²ç»Ÿè®¡
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("ç³»ç»Ÿè§’è‰²æ•°", len(roles))
    with col2:
        admin_count = len([u for u in get_all_users() if u['role_name'] == 'è¶…çº§ç®¡ç†å‘˜'])
        st.metric("è¶…çº§ç®¡ç†å‘˜", admin_count)
    with col3:
        manager_count = len([u for u in get_all_users() if u['role_name'] == 'æ¨¡å…·åº“ç®¡ç†å‘˜'])
        st.metric("æ¨¡å…·åº“ç®¡ç†å‘˜", manager_count)
    with col4:
        operator_count = len([u for u in get_all_users() if u['role_name'] == 'å†²å‹æ“ä½œå·¥'])
        st.metric("å†²å‹æ“ä½œå·¥", operator_count)
    
    st.markdown("---")
    
    # æ˜¾ç¤ºè§’è‰²è¯¦æƒ…
    for role in roles:
        with st.expander(f"**{role['role_name']}** - {role['description']}", expanded=False):
            col1, col2 = st.columns([2, 1])
            
            with col1:
                st.markdown(f"**è§’è‰²ID**: {role['role_id']}")
                st.markdown(f"**æè¿°**: {role['description']}")
                
                # è·å–è¯¥è§’è‰²çš„ç”¨æˆ·æ•°
                role_users = [u for u in get_all_users() if u['role_name'] == role['role_name']]
                st.markdown(f"**ç”¨æˆ·æ•°**: {len(role_users)} äºº")
                
                # æ˜¾ç¤ºæƒé™åˆ—è¡¨ï¼ˆç¡¬ç¼–ç çš„æƒé™æ˜ å°„ï¼‰
                st.markdown("**ä¸»è¦æƒé™**:")
                permissions = get_role_permissions_display(role['role_name'])
                for perm in permissions:
                    st.markdown(f"- {perm}")
            
            with col2:
                # æ˜¾ç¤ºè¯¥è§’è‰²çš„ç”¨æˆ·åˆ—è¡¨
                if role_users:
                    st.markdown("**è¯¥è§’è‰²ç”¨æˆ·**:")
                    for user in role_users[:5]:  # æœ€å¤šæ˜¾ç¤º5ä¸ª
                        st.markdown(f"- {user['full_name']} ({user['username']})")
                    if len(role_users) > 5:
                        st.markdown(f"... è¿˜æœ‰ {len(role_users) - 5} ä¸ªç”¨æˆ·")
    
    # æƒé™è¯´æ˜
    with st.expander("ğŸ“– æƒé™è¯¦ç»†è¯´æ˜", expanded=False):
        st.markdown("""
        #### æƒé™ç­‰çº§è¯´æ˜
        
        1. **è¶…çº§ç®¡ç†å‘˜** - æœ€é«˜æƒé™
           - å®Œå…¨æ§åˆ¶ç³»ç»Ÿæ‰€æœ‰åŠŸèƒ½
           - ç”¨æˆ·å’Œè§’è‰²ç®¡ç†
           - ç³»ç»Ÿé…ç½®å’Œç»´æŠ¤
           - æ•°æ®å¤‡ä»½å’Œæ¢å¤
        
        2. **æ¨¡å…·åº“ç®¡ç†å‘˜** - ä¸šåŠ¡ç®¡ç†æƒé™
           - æ¨¡å…·å°è´¦ç®¡ç†ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
           - å€Ÿç”¨ç”³è¯·å®¡æ‰¹
           - ç»´ä¿®ä»»åŠ¡åˆ†é…
           - ä¸šåŠ¡æŠ¥è¡¨æŸ¥çœ‹
        
        3. **æ¨¡å…·å·¥** - æ‰§è¡Œæƒé™
           - ç»´ä¿®ä»»åŠ¡æ‰§è¡Œ
           - ç»´ä¿®è®°å½•å¡«å†™
           - éƒ¨ä»¶æ›´æ¢è®°å½•
           - ä¸ªäººä»»åŠ¡æŸ¥çœ‹
        
        4. **å†²å‹æ“ä½œå·¥** - åŸºç¡€æƒé™
           - æ¨¡å…·ä¿¡æ¯æŸ¥è¯¢
           - å€Ÿç”¨ç”³è¯·æäº¤
           - ä½¿ç”¨è®°å½•å¡«å†™
           - ä¸ªäººè®°å½•æŸ¥çœ‹
        """)

def show_activity_logs():
    """æ˜¾ç¤ºæ“ä½œæ—¥å¿—"""
    st.markdown("### ğŸ“Š ç”¨æˆ·æ“ä½œæ—¥å¿—")
    
    # æŸ¥çœ‹ç‰¹å®šç”¨æˆ·çš„æ—¥å¿—
    if 'view_user_logs' in st.session_state:
        user_id = st.session_state['view_user_logs']
        user = next((u for u in get_all_users() if u['user_id'] == user_id), None)
        if user:
            st.info(f"æ­£åœ¨æŸ¥çœ‹ç”¨æˆ· **{user['full_name']} ({user['username']})** çš„æ“ä½œæ—¥å¿—")
            if st.button("ğŸ”™ è¿”å›å…¨éƒ¨æ—¥å¿—"):
                del st.session_state['view_user_logs']
                st.rerun()
    
    # æŸ¥è¯¢æ¡ä»¶
    col1, col2, col3, col4 = st.columns([2, 2, 1, 1])
    
    with col1:
        if 'view_user_logs' not in st.session_state:
            user_filter = st.selectbox(
                "ç”¨æˆ·ç­›é€‰",
                ["å…¨éƒ¨"] + [(u['user_id'], f"{u['full_name']} ({u['username']})") 
                           for u in get_all_users()],
                format_func=lambda x: "å…¨éƒ¨" if x == "å…¨éƒ¨" else x[1],
                key="log_user_filter"
            )
        else:
            user_filter = st.session_state['view_user_logs']
    
    with col2:
        action_types = ['å…¨éƒ¨', 'ç™»å½•', 'åˆ›å»º', 'ä¿®æ”¹', 'åˆ é™¤', 'å®¡æ‰¹']
        action_filter = st.selectbox("æ“ä½œç±»å‹", action_types, key="action_filter")
    
    with col3:
        days = st.number_input("æœ€è¿‘å¤©æ•°", min_value=1, max_value=90, value=7, key="log_days")
    
    with col4:
        st.markdown("<br>", unsafe_allow_html=True)
        if st.button("ğŸ”„ åˆ·æ–°æ—¥å¿—"):
            st.rerun()
    
    # è·å–æ—¥å¿—
    if 'view_user_logs' in st.session_state:
        user_id = st.session_state['view_user_logs']
    else:
        user_id = None if user_filter == "å…¨éƒ¨" else user_filter[0]
    
    logs = get_user_activity_log(user_id, days)
    
    # åº”ç”¨æ“ä½œç±»å‹ç­›é€‰
    if action_filter != 'å…¨éƒ¨' and logs:
        action_map = {
            'ç™»å½•': ['LOGIN', 'LOGOUT'],
            'åˆ›å»º': ['CREATE_USER', 'CREATE_MOLD', 'CREATE_LOAN', 'CREATE_MAINTENANCE'],
            'ä¿®æ”¹': ['UPDATE_USER', 'UPDATE_MOLD', 'UPDATE_LOAN', 'UPDATE_MAINTENANCE'],
            'åˆ é™¤': ['DELETE_USER', 'DELETE_MOLD', 'DELETE_LOAN', 'DELETE_MAINTENANCE'],
            'å®¡æ‰¹': ['APPROVE_LOAN', 'REJECT_LOAN']
        }
        filter_actions = action_map.get(action_filter, [])
        logs = [log for log in logs if any(action in log['action_type'] for action in filter_actions)]
    
    # æ˜¾ç¤ºæ—¥å¿—ç»Ÿè®¡
    if logs:
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("æ—¥å¿—æ¡æ•°", len(logs))
        with col2:
            unique_users = len(set(log['user_id'] for log in logs if log['user_id']))
            st.metric("æ´»è·ƒç”¨æˆ·", unique_users)
        with col3:
            login_count = len([log for log in logs if 'LOGIN' in log['action_type']])
            st.metric("ç™»å½•æ¬¡æ•°", login_count)
        with col4:
            # è®¡ç®—ä»Šæ—¥æ“ä½œæ•°
            today = datetime.now().date()
            today_logs = [log for log in logs if log['timestamp'].date() == today]
            st.metric("ä»Šæ—¥æ“ä½œ", len(today_logs))
    
    st.markdown("---")
    
    # æ˜¾ç¤ºæ—¥å¿—åˆ—è¡¨
    if logs:
        # è½¬æ¢ä¸ºDataFrameä»¥ä¾¿æ˜¾ç¤º
        df = pd.DataFrame(logs)
        
        # æ ¼å¼åŒ–æ˜¾ç¤º
        df['æ—¶é—´'] = pd.to_datetime(df['timestamp']).dt.strftime('%Y-%m-%d %H:%M:%S')
        df['æ“ä½œç±»å‹'] = df['action_type'].map(get_action_type_display)
        df['ç”¨æˆ·'] = df.apply(lambda x: f"{x['full_name']} ({x['username']})" 
                            if x['username'] else 'ç³»ç»Ÿ', axis=1)
        
        # é€‰æ‹©æ˜¾ç¤ºçš„åˆ—
        display_columns = ['æ—¶é—´', 'ç”¨æˆ·', 'æ“ä½œç±»å‹', 'target_resource', 'target_id']
        
        # ä½¿ç”¨è¡¨æ ¼æ˜¾ç¤º
        st.dataframe(
            df[display_columns],
            column_config={
                'æ—¶é—´': st.column_config.TextColumn('æ“ä½œæ—¶é—´', width=150),
                'ç”¨æˆ·': st.column_config.TextColumn('æ“ä½œç”¨æˆ·', width=150),
                'æ“ä½œç±»å‹': st.column_config.TextColumn('æ“ä½œç±»å‹', width=120),
                'target_resource': st.column_config.TextColumn('ç›®æ ‡èµ„æº', width=100),
                'target_id': st.column_config.TextColumn('ç›®æ ‡ID', width=80),
            },
            hide_index=True,
            use_container_width=True
        )
        
        # å¯¼å‡ºåŠŸèƒ½
        st.markdown("---")
        col1, col2 = st.columns([1, 4])
        with col1:
            csv = df[display_columns].to_csv(index=False, encoding='utf-8-sig')
            st.download_button(
                label="ğŸ“¥ å¯¼å‡ºæ—¥å¿—",
                data=csv,
                file_name=f"æ“ä½œæ—¥å¿—_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                mime="text/csv"
            )
    else:
        st.info("ğŸ˜Š æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ“ä½œæ—¥å¿—")

def get_role_permissions_display(role_name):
    """è·å–è§’è‰²æƒé™çš„æ˜¾ç¤ºæ–‡æœ¬"""
    permissions_map = {
        'è¶…çº§ç®¡ç†å‘˜': [
            'âœ… ç³»ç»Ÿæ‰€æœ‰åŠŸèƒ½çš„å®Œå…¨è®¿é—®æƒé™',
            'âœ… ç”¨æˆ·è´¦æˆ·ç®¡ç†ï¼ˆåˆ›å»ºã€ç¼–è¾‘ã€ç¦ç”¨ï¼‰',
            'âœ… è§’è‰²æƒé™é…ç½®',
            'âœ… ç³»ç»Ÿå‚æ•°è®¾ç½®',
            'âœ… æ•°æ®å¤‡ä»½å’Œæ¢å¤',
            'âœ… æŸ¥çœ‹æ‰€æœ‰æ“ä½œæ—¥å¿—'
        ],
        'æ¨¡å…·åº“ç®¡ç†å‘˜': [
            'âœ… æ¨¡å…·å°è´¦ç®¡ç†ï¼ˆæ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤ï¼‰',
            'âœ… å€Ÿç”¨ç”³è¯·å®¡æ‰¹',
            'âœ… ç»´ä¿®ä»»åŠ¡åˆ†é…',
            'âœ… æŸ¥çœ‹ç»Ÿè®¡æŠ¥è¡¨',
            'âœ… ç®¡ç†å­˜å‚¨ä½ç½®å’Œåˆ†ç±»',
            'âŒ ç”¨æˆ·ç®¡ç†æƒé™'
        ],
        'æ¨¡å…·å·¥': [
            'âœ… æŸ¥çœ‹åˆ†é…çš„ç»´ä¿®ä»»åŠ¡',
            'âœ… å¡«å†™ç»´ä¿®è®°å½•',
            'âœ… æ›´æ–°ä»»åŠ¡çŠ¶æ€',
            'âœ… è®°å½•éƒ¨ä»¶æ›´æ¢',
            'âŒ æ¨¡å…·ä¿¡æ¯ç¼–è¾‘æƒé™',
            'âŒ å€Ÿç”¨å®¡æ‰¹æƒé™'
        ],
        'å†²å‹æ“ä½œå·¥': [
            'âœ… æŸ¥è¯¢æ¨¡å…·ä¿¡æ¯',
            'âœ… æäº¤å€Ÿç”¨ç”³è¯·',
            'âœ… æŸ¥çœ‹ä¸ªäººå€Ÿç”¨è®°å½•',
            'âœ… å¡«å†™ä½¿ç”¨è®°å½•',
            'âŒ æ¨¡å…·ä¿¡æ¯ç¼–è¾‘æƒé™',
            'âŒ æŸ¥çœ‹ä»–äººè®°å½•'
        ]
    }
    return permissions_map.get(role_name, ['æš‚æ— æƒé™è¯´æ˜'])

def get_action_type_display(action_type):
    """è·å–æ“ä½œç±»å‹çš„ä¸­æ–‡æ˜¾ç¤º"""
    action_map = {
        'LOGIN': 'ç”¨æˆ·ç™»å½•',
        'LOGOUT': 'ç”¨æˆ·ç™»å‡º',
        'CREATE_USER': 'åˆ›å»ºç”¨æˆ·',
        'UPDATE_USER': 'æ›´æ–°ç”¨æˆ·',
        'DELETE_USER': 'åˆ é™¤ç”¨æˆ·',
        'DISABLE_USER': 'ç¦ç”¨ç”¨æˆ·',
        'ENABLE_USER': 'å¯ç”¨ç”¨æˆ·',
        'CREATE_MOLD': 'æ–°å¢æ¨¡å…·',
        'UPDATE_MOLD': 'æ›´æ–°æ¨¡å…·',
        'DELETE_MOLD': 'åˆ é™¤æ¨¡å…·',
        'CREATE_LOAN': 'åˆ›å»ºå€Ÿç”¨',
        'UPDATE_LOAN': 'æ›´æ–°å€Ÿç”¨',
        'APPROVE_LOAN': 'æ‰¹å‡†å€Ÿç”¨',
        'REJECT_LOAN': 'é©³å›å€Ÿç”¨',
        'CREATE_MAINTENANCE': 'åˆ›å»ºç»´ä¿®',
        'UPDATE_MAINTENANCE': 'æ›´æ–°ç»´ä¿®',
        'VIEW_REPORT': 'æŸ¥çœ‹æŠ¥è¡¨',
        'EXPORT_DATA': 'å¯¼å‡ºæ•°æ®',
        'SYSTEM_CONFIG': 'ç³»ç»Ÿé…ç½®'
    }
    return action_map.get(action_type, action_type)

# ç‹¬ç«‹è¿è¡Œæµ‹è¯•
if __name__ == "__main__":
    # æ¨¡æ‹Ÿç™»å½•çŠ¶æ€
    if 'logged_in' not in st.session_state:
        st.session_state['logged_in'] = True
        st.session_state['user_id'] = 1
        st.session_state['user_role'] = 'è¶…çº§ç®¡ç†å‘˜'
        st.session_state['username'] = 'admin'
    
    show()