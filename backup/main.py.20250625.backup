# app/main.py
import streamlit as st
from utils.auth import login_user  # å‡è®¾ä½ çš„è®¤è¯å‡½æ•°åœ¨auth.pyä¸­

# --- é¡µé¢é…ç½® ---
st.set_page_config(
    page_title="æ¨¡å…·ç®¡ç†ç³»ç»Ÿ",
    page_icon="ğŸ› ï¸",
    layout="wide"
)

# --- ä¼šè¯çŠ¶æ€åˆå§‹åŒ– ---
if 'logged_in' not in st.session_state:
    st.session_state['logged_in'] = False
if 'username' not in st.session_state:
    st.session_state['username'] = ''
if 'role' not in st.session_state:
    st.session_state['role'] = ''

# --- ç™»å½•é€»è¾‘ ---
def show_login_form():
    """æ˜¾ç¤ºç™»å½•è¡¨å•"""
    with st.form("login_form"):
        st.title("è•´æ°æ¨¡å…·å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ç³»ç»Ÿ")
        username = st.text_input("ç”¨æˆ·å", key="login_username")
        password = st.text_input("å¯†ç ", type="password", key="login_password")
        submitted = st.form_submit_button("ç™»å½•")

        if submitted:
            user_info = login_user(username, password) # è°ƒç”¨ä½ çš„ç™»å½•éªŒè¯å‡½æ•°
            if user_info:
                st.session_state['logged_in'] = True
                st.session_state['username'] = user_info['username']
                st.session_state['role'] = user_info['role']
                st.rerun() # é‡æ–°è¿è¡Œè„šæœ¬ä»¥æ˜¾ç¤ºä¸»åº”ç”¨
            else:
                st.error("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")

# --- ä¸»ç¨‹åºæµ ---
if not st.session_state['logged_in']:
    show_login_form()
else:
    # ç”¨æˆ·å·²ç™»å½•
    st.sidebar.success(f"æ¬¢è¿, {st.session_state['username']}!")
    st.sidebar.write(f"è§’è‰²: {st.session_state['role']}")

    if st.sidebar.button("é€€å‡ºç™»å½•"):
        # æ¸…ç†ä¼šè¯çŠ¶æ€å¹¶é‡æ–°è¿è¡Œä»¥æ˜¾ç¤ºç™»å½•é¡µé¢
        for key in list(st.session_state.keys()):
            del st.session_state[key]
        st.rerun()

    # --- æ¬¢è¿é¡µé¢ ---
    st.title("æ¬¢è¿ä½¿ç”¨æ¨¡å…·ç®¡ç†ç³»ç»Ÿ")
    st.write("è¯·ä»å·¦ä¾§çš„å¯¼èˆªæ é€‰æ‹©ä¸€ä¸ªåŠŸèƒ½æ¨¡å—å¼€å§‹æ“ä½œã€‚")
    
    # è¿™é‡Œçš„ä»£ç åªä¼šåœ¨ç”¨æˆ·ç™»å½•åï¼Œä¸”æ²¡æœ‰é€‰æ‹©ä»»ä½•å…¶ä»–é¡µé¢æ—¶æ˜¾ç¤º
    # Streamlit ä¼šè‡ªåŠ¨å¤„ç†é¡µé¢çš„æ˜¾ç¤º