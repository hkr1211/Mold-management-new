# main.py - æ›´æ–°ç‰ˆæœ¬ï¼Œé›†æˆç»´ä¿®ä¿å…»æ¨¡å—
import streamlit as st
import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
project_root = Path(__file__).parent
sys.path.append(str(project_root))

# å¯¼å…¥å„ä¸ªé¡µé¢æ¨¡å—
try:
    from pages import mold_management, loan_management, maintenance_management
    from pages import system_management
    from utils.database import test_connection
    from utils.auth import authenticate_user, has_permission, get_current_user_info
except ImportError as e:
    st.error(f"æ¨¡å—å¯¼å…¥å¤±è´¥: {e}")
    st.stop()

# é…ç½®é¡µé¢
st.set_page_config(
    page_title="è•´æ°é‡‘å±å†²å‹æ¨¡å…·ç®¡ç†ç³»ç»Ÿ",
    page_icon="ğŸ”§",
    layout="wide",
    initial_sidebar_state="expanded"
)

# CSSæ ·å¼
st.markdown("""
<style>
    .main-header {
        text-align: center;
        color: #1f77b4;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(90deg, #f0f2f6 0%, #ffffff 100%);
        border-radius: 10px;
        border-left: 5px solid #1f77b4;
    }
    .metric-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin: 10px 0;
        border-left: 4px solid #1f77b4;
    }
    .nav-button {
        width: 100%;
        margin: 5px 0;
        padding: 10px;
        background: linear-gradient(45deg, #1f77b4, #ff7f0e);
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: bold;
    }
    .nav-button:hover {
        background: linear-gradient(45deg, #0d47a1, #e65100);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .status-urgent { color: #d32f2f; font-weight: bold; }
    .status-warning { color: #f57c00; font-weight: bold; }
    .status-normal { color: #388e3c; font-weight: bold; }
    .sidebar-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 3px solid #1f77b4;
    }
</style>
""", unsafe_allow_html=True)

def init_session_state():
    """åˆå§‹åŒ–ä¼šè¯çŠ¶æ€"""
    if 'authenticated' not in st.session_state:
        st.session_state.authenticated = False
    if 'logged_in' not in st.session_state:
        st.session_state.logged_in = False
    if 'user_id' not in st.session_state:
        st.session_state.user_id = None
    if 'username' not in st.session_state:
        st.session_state.username = None
    if 'user_role' not in st.session_state:
        st.session_state.user_role = None
    if 'current_page' not in st.session_state:
        st.session_state.current_page = 'dashboard'

def show_login():
    """æ˜¾ç¤ºç™»å½•é¡µé¢"""
    st.markdown('<div class="main-header"><h1>ğŸ”§ è•´æ°é‡‘å±å†²å‹æ¨¡å…·ç®¡ç†ç³»ç»Ÿ</h1><p>è¯·ç™»å½•ä»¥è®¿é—®ç³»ç»ŸåŠŸèƒ½</p></div>', unsafe_allow_html=True)
    
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        with st.form("login_form"):
            st.markdown("### ğŸ” ç”¨æˆ·ç™»å½•")
            username = st.text_input("ç”¨æˆ·å", placeholder="è¯·è¾“å…¥ç”¨æˆ·å")
            password = st.text_input("å¯†ç ", type="password", placeholder="è¯·è¾“å…¥å¯†ç ")
            
            submitted = st.form_submit_button("ç™»å½•", use_container_width=True)
            
            if submitted:
                if username and password:
                    # ä½¿ç”¨å®é™…çš„è®¤è¯å‡½æ•°
                    user_info = authenticate_user(username, password)
                    
                    if user_info:
                        st.session_state.authenticated = True
                        st.session_state.logged_in = True
                        st.session_state.user_id = user_info['user_id']
                        st.session_state.username = user_info['username']
                        st.session_state.user_role = user_info['role_name']
                        st.session_state.full_name = user_info['full_name']
                        st.success(f"æ¬¢è¿ {user_info['full_name']}ï¼")
                        st.rerun()
                    else:
                        st.error("ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
                else:
                    st.error("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ")
        
        # æ˜¾ç¤ºæ¼”ç¤ºè´¦æˆ·ä¿¡æ¯
        with st.expander("ğŸ’¡ æ¼”ç¤ºè´¦æˆ·ä¿¡æ¯", expanded=False):
            st.markdown("""
            **æµ‹è¯•è´¦æˆ·ï¼š**
            - è¶…çº§ç®¡ç†å‘˜: `admin` / `admin123`
            - æ¨¡å…·åº“ç®¡ç†å‘˜: `mold_admin` / `mold123` 
            - æ¨¡å…·å·¥: `technician` / `tech123`
            - å†²å‹æ“ä½œå·¥: `operator` / `op123`
            """)

def show_sidebar():
    """æ˜¾ç¤ºä¾§è¾¹æ å¯¼èˆª"""
    with st.sidebar:
        # ç”¨æˆ·ä¿¡æ¯
        st.markdown(f'<div class="sidebar-section">', unsafe_allow_html=True)
        st.markdown(f"**ğŸ‘¤ {st.session_state.get('full_name', 'ç”¨æˆ·')}**")
        st.markdown(f"**ğŸ“‹ {st.session_state.get('user_role', 'è§’è‰²')}**")
        st.markdown('</div>', unsafe_allow_html=True)
        
        # å¯¼èˆªèœå•
        st.markdown("### ğŸ“‹ åŠŸèƒ½èœå•")
        
        user_role = st.session_state.get('user_role', '')
        
        # æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒçš„èœå•
        menu_items = []
        
        # ä»ªè¡¨æ¿ - æ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥è®¿é—®
        menu_items.append(("ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ", "dashboard"))
        
        # æ¨¡å…·ç®¡ç† - ç®¡ç†å‘˜å’Œæ¨¡å…·åº“ç®¡ç†å‘˜
        if user_role in ['è¶…çº§ç®¡ç†å‘˜', 'æ¨¡å…·åº“ç®¡ç†å‘˜']:
            menu_items.append(("ğŸ“‹ æ¨¡å…·ç®¡ç†", "mold_management"))
        
        # æ¨¡å…·æŸ¥è¯¢ - å†²å‹æ“ä½œå·¥åªèƒ½æŸ¥è¯¢
        if user_role == 'å†²å‹æ“ä½œå·¥':
            menu_items.append(("ğŸ” æ¨¡å…·æŸ¥è¯¢", "mold_query"))
        
        # å€Ÿç”¨ç®¡ç† - é™¤è¶…çº§ç®¡ç†å‘˜å¤–çš„æ‰€æœ‰ç”¨æˆ·
        if user_role in ['æ¨¡å…·åº“ç®¡ç†å‘˜', 'å†²å‹æ“ä½œå·¥']:
            menu_items.append(("ğŸ› ï¸ å€Ÿç”¨ç®¡ç†", "loan_management"))
        
        # ç»´ä¿®ä¿å…» - ç®¡ç†å‘˜å’Œæ¨¡å…·å·¥
        if user_role in ['è¶…çº§ç®¡ç†å‘˜', 'æ¨¡å…·åº“ç®¡ç†å‘˜', 'æ¨¡å…·å·¥']:
            menu_items.append(("ğŸ”§ ç»´ä¿®ä¿å…»", "maintenance_management"))
        
        # ç³»ç»Ÿç®¡ç† - ä»…è¶…çº§ç®¡ç†å‘˜
        if user_role == 'è¶…çº§ç®¡ç†å‘˜':
            menu_items.append(("âš™ï¸ ç³»ç»Ÿç®¡ç†", "system_management"))

        # æ˜¾ç¤ºèœå•æŒ‰é’®
        for menu_text, menu_key in menu_items:
            if st.button(menu_text, key=f"nav_{menu_key}", use_container_width=True):
                st.session_state.current_page = menu_key
                # æ¸…é™¤ç›¸å…³çš„è·³è½¬çŠ¶æ€
                for key in ['maintenance_tab', 'create_maintenance_mold_id', 'update_task_id']:
                    if key in st.session_state:
                        del st.session_state[key]
                st.rerun()
        
        st.markdown("---")
        
        # å¿«é€Ÿæ“ä½œ
        st.markdown("### âš¡ å¿«é€Ÿæ“ä½œ")
        
        # ç»´ä¿®é¢„è­¦å¿«æ·æ–¹å¼
        if user_role in ['è¶…çº§ç®¡ç†å‘˜', 'æ¨¡å…·åº“ç®¡ç†å‘˜', 'æ¨¡å…·å·¥']:
            if st.button("âš ï¸ ç»´ä¿®é¢„è­¦", key="quick_alerts", use_container_width=True):
                st.session_state.current_page = "maintenance_management"
                st.session_state.maintenance_tab = "alerts"
                st.rerun()
        
        # æ–°å»ºå€Ÿç”¨ç”³è¯·å¿«æ·æ–¹å¼
        if user_role == 'å†²å‹æ“ä½œå·¥':
            if st.button("ğŸ“ æ–°å»ºå€Ÿç”¨", key="quick_loan", use_container_width=True):
                st.session_state.current_page = "loan_management"
                st.rerun()
        
        st.markdown("---")
        
        # ç™»å‡ºæŒ‰é’®
        if st.button("ğŸšª ç™»å‡º", key="logout", use_container_width=True):
            from utils.auth import logout_user
            logout_user()
            st.rerun()

def show_dashboard():
    """æ˜¾ç¤ºç³»ç»Ÿæ¦‚è§ˆä»ªè¡¨æ¿"""
    st.markdown('<div class="main-header"><h1>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h1><p>è•´æ°é‡‘å±å†²å‹æ¨¡å…·ç®¡ç†ç³»ç»Ÿ</p></div>', unsafe_allow_html=True)
    
    try:
        from utils.database import execute_query
        
        # è·å–åŸºç¡€ç»Ÿè®¡æ•°æ®
        stats_queries = {
            'total_molds': "SELECT COUNT(*) FROM molds",
            'available_molds': "SELECT COUNT(*) FROM molds m JOIN mold_statuses ms ON m.current_status_id = ms.status_id WHERE ms.status_name = 'é—²ç½®'",
            'in_use_molds': "SELECT COUNT(*) FROM molds m JOIN mold_statuses ms ON m.current_status_id = ms.status_id WHERE ms.status_name IN ('ä½¿ç”¨ä¸­', 'å·²å€Ÿå‡º')",
            'maintenance_molds': "SELECT COUNT(*) FROM molds m JOIN mold_statuses ms ON m.current_status_id = ms.status_id WHERE ms.status_name IN ('ç»´ä¿®ä¸­', 'ä¿å…»ä¸­', 'å¾…ç»´ä¿®', 'å¾…ä¿å…»')"
        }
        
        stats = {}
        for key, query in stats_queries.items():
            try:
                result = execute_query(query, fetch_all=True)
                stats[key] = result[0][0] if result else 0
            except:
                stats[key] = 0
        
        # æ˜¾ç¤ºç»Ÿè®¡å¡ç‰‡
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("ğŸ­ æ¨¡å…·æ€»æ•°", stats['total_molds'])
        
        with col2:
            st.metric("âœ… å¯ç”¨æ¨¡å…·", stats['available_molds'])
        
        with col3:
            st.metric("ğŸ”„ ä½¿ç”¨ä¸­", stats['in_use_molds'])
        
        with col4:
            st.metric("ğŸ”§ ç»´æŠ¤ä¸­", stats['maintenance_molds'])
        
        # æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒçš„è¯¦ç»†ä¿¡æ¯
        user_role = st.session_state.get('user_role', '')
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown("### ğŸ“‹ å¿«é€Ÿè®¿é—®")
            
            if user_role in ['è¶…çº§ç®¡ç†å‘˜', 'æ¨¡å…·åº“ç®¡ç†å‘˜']:
                if st.button("ğŸ“‹ æ¨¡å…·ç®¡ç†", key="dash_mold_mgmt", use_container_width=True):
                    st.session_state.current_page = "mold_management"
                    st.rerun()
                
                if st.button("ğŸ”§ ç»´ä¿®ä¿å…»", key="dash_maintenance", use_container_width=True):
                    st.session_state.current_page = "maintenance_management"
                    st.rerun()
            
            if user_role in ['æ¨¡å…·åº“ç®¡ç†å‘˜', 'å†²å‹æ“ä½œå·¥']:
                if st.button("ğŸ› ï¸ å€Ÿç”¨ç®¡ç†", key="dash_loan", use_container_width=True):
                    st.session_state.current_page = "loan_management"
                    st.rerun()
            
            if user_role == 'å†²å‹æ“ä½œå·¥':
                if st.button("ğŸ” æ¨¡å…·æŸ¥è¯¢", key="dash_query", use_container_width=True):
                    st.session_state.current_page = "mold_query"
                    st.rerun()
        
        with col2:
            st.markdown("### âš ï¸ ç³»ç»Ÿæé†’")
            
            # è·å–ç»´ä¿®é¢„è­¦ä¿¡æ¯ï¼ˆå¦‚æœç”¨æˆ·æœ‰æƒé™ï¼‰
            if user_role in ['è¶…çº§ç®¡ç†å‘˜', 'æ¨¡å…·åº“ç®¡ç†å‘˜', 'æ¨¡å…·å·¥']:
                try:
                    alert_query = """
                    SELECT 
                        COUNT(*) as alert_count,
                        'urgent' as alert_type
                    FROM molds m
                    JOIN mold_statuses ms ON m.current_status_id = ms.status_id
                    WHERE ms.status_name IN ('å¾…ç»´ä¿®', 'å¾…ä¿å…»')
                    
                    UNION ALL
                    
                    SELECT 
                        COUNT(*) as alert_count,
                        'overdue' as alert_type
                    FROM molds m
                    WHERE m.maintenance_cycle_strokes > 0 
                    AND m.accumulated_strokes >= m.maintenance_cycle_strokes
                    
                    UNION ALL
                    
                    SELECT 
                        COUNT(*) as alert_count,
                        'warning' as alert_type
                    FROM molds m
                    WHERE m.theoretical_lifespan_strokes > 0 
                    AND m.accumulated_strokes >= m.theoretical_lifespan_strokes * 0.9
                    """
                    
                    alerts = execute_query(alert_query, fetch_all=True)
                    
                    for alert in alerts:
                        count = alert[0]
                        alert_type = alert[1]
                        
                        if count > 0:
                            if alert_type == 'urgent':
                                st.error(f"ğŸš¨ {count} ä¸ªæ¨¡å…·éœ€è¦ç´§æ€¥ç»´ä¿®/ä¿å…»")
                            elif alert_type == 'overdue':
                                st.warning(f"â° {count} ä¸ªæ¨¡å…·ä¿å…»è¶…æœŸ")
                            elif alert_type == 'warning':
                                st.info(f"âš¡ {count} ä¸ªæ¨¡å…·å³å°†åˆ°æœŸ")
                    
                    # å¦‚æœæœ‰é¢„è­¦ï¼Œæ˜¾ç¤ºå¿«é€Ÿè·³è½¬æŒ‰é’®
                    total_alerts = sum([alert[0] for alert in alerts])
                    if total_alerts > 0:
                        if st.button("ğŸ”§ æŸ¥çœ‹ç»´ä¿®é¢„è­¦", key="dash_alerts", use_container_width=True):
                            st.session_state.current_page = "maintenance_management"
                            st.session_state.maintenance_tab = "alerts"
                            st.rerun()
                    else:
                        st.success("âœ… å½“å‰æ²¡æœ‰ç»´ä¿®é¢„è­¦")
                
                except Exception as e:
                    st.warning("æ— æ³•è·å–é¢„è­¦ä¿¡æ¯")
            
            # æ˜¾ç¤ºè¿‘æœŸæ´»åŠ¨ï¼ˆå¦‚æœæœ‰ï¼‰
            try:
                recent_activity_query = """
                SELECT 
                    'maintenance' as activity_type,
                    COUNT(*) as count
                FROM mold_maintenance_logs
                WHERE maintenance_start_timestamp >= CURRENT_DATE - INTERVAL '7 days'
                
                UNION ALL
                
                SELECT 
                    'loan' as activity_type,
                    COUNT(*) as count
                FROM mold_loan_records
                WHERE application_timestamp >= CURRENT_DATE - INTERVAL '7 days'
                """
                
                activities = execute_query(recent_activity_query, fetch_all=True)
                
                st.markdown("**ğŸ“ˆ è¿‘7å¤©æ´»åŠ¨**")
                for activity in activities:
                    activity_type = activity[1]
                    count = activity[0]
                    
                    if activity_type == 'maintenance':
                        st.write(f"ğŸ”§ ç»´ä¿®ä¿å…»: {count} æ¬¡")
                    elif activity_type == 'loan':
                        st.write(f"ğŸ“‹ å€Ÿç”¨ç”³è¯·: {count} æ¬¡")
            
            except:
                pass
    
    except Exception as e:
        st.error(f"è·å–ç³»ç»Ÿæ¦‚è§ˆæ•°æ®å¤±è´¥: {e}")
        
        # æ˜¾ç¤ºé™æ€æ¬¢è¿ä¿¡æ¯
        st.markdown("""
        ### ğŸ‘‹ æ¬¢è¿ä½¿ç”¨è•´æ°é‡‘å±å†²å‹æ¨¡å…·ç®¡ç†ç³»ç»Ÿ
        
        **ç³»ç»ŸåŠŸèƒ½ï¼š**
        - ğŸ“‹ æ¨¡å…·å°è´¦ç®¡ç†
        - ğŸ› ï¸ æ¨¡å…·å€Ÿç”¨æµç¨‹
        - ğŸ”§ ç»´ä¿®ä¿å…»ç®¡ç†
        - ğŸ“Š ç»Ÿè®¡åˆ†ææŠ¥è¡¨
        
        è¯·ä½¿ç”¨å·¦ä¾§èœå•è®¿é—®å„åŠŸèƒ½æ¨¡å—ã€‚
        """)

def show_mold_query():
    """æ˜¾ç¤ºæ¨¡å…·æŸ¥è¯¢é¡µé¢ï¼ˆåªè¯»ç‰ˆæœ¬ï¼Œä¾›å†²å‹æ“ä½œå·¥ä½¿ç”¨ï¼‰"""
    st.title("ğŸ” æ¨¡å…·æŸ¥è¯¢")
    
    # è°ƒç”¨æ¨¡å…·ç®¡ç†æ¨¡å—çš„åªè¯»æŸ¥è¯¢åŠŸèƒ½
    try:
        mold_management.show_mold_list_readonly()
    except AttributeError:
        # å¦‚æœæ²¡æœ‰åªè¯»å‡½æ•°ï¼Œä½¿ç”¨åŸºæœ¬çš„æŸ¥è¯¢æ˜¾ç¤º
        st.info("æ¨¡å…·æŸ¥è¯¢åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...")

# åœ¨ main.py ä¸­æ›¿æ¢ show_system_management å‡½æ•°

def show_system_management():
    """æ˜¾ç¤ºç³»ç»Ÿç®¡ç†é¡µé¢ï¼ˆä»…è¶…çº§ç®¡ç†å‘˜ï¼‰"""
    # æƒé™æ£€æŸ¥
    if st.session_state.get('user_role') != 'è¶…çº§ç®¡ç†å‘˜':
        st.error("æƒé™ä¸è¶³ï¼šä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ­¤åŠŸèƒ½")
        return
    
    # å¯¼å…¥ç³»ç»Ÿç®¡ç†æ¨¡å—
    try:
        from pages import system_management
        system_management.show()
    except ImportError:
        # å¦‚æœæ¨¡å—è¿˜æœªåˆ›å»ºï¼Œæ˜¾ç¤ºåŸæ¥çš„ç®€å•ç‰ˆæœ¬
        st.title("âš™ï¸ ç³»ç»Ÿç®¡ç†")
        
        tab1, tab2, tab3 = st.tabs(["ğŸ‘¥ ç”¨æˆ·ç®¡ç†", "ğŸ”§ ç³»ç»Ÿé…ç½®", "ğŸ“Š ç³»ç»Ÿç›‘æ§"])
        
        with tab1:
            st.markdown("### ğŸ‘¥ ç”¨æˆ·ç®¡ç†")
            st.info("ç”¨æˆ·ç®¡ç†åŠŸèƒ½å¼€å‘ä¸­...")
        
        with tab2:
            st.markdown("### ğŸ”§ ç³»ç»Ÿé…ç½®")
            st.info("ç³»ç»Ÿé…ç½®åŠŸèƒ½å¼€å‘ä¸­...")
            
            # æ•°æ®åº“è¿æ¥æµ‹è¯•
            st.markdown("#### æ•°æ®åº“è¿æ¥æµ‹è¯•")
            if st.button("æµ‹è¯•æ•°æ®åº“è¿æ¥"):
                if test_connection():
                    st.success("âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸")
                else:
                    st.error("âŒ æ•°æ®åº“è¿æ¥å¤±è´¥")
        
        with tab3:
            st.markdown("### ğŸ“Š ç³»ç»Ÿç›‘æ§")
            st.info("ç³»ç»Ÿç›‘æ§åŠŸèƒ½å¼€å‘ä¸­...")

# åŒæ—¶ï¼Œåœ¨ main.py çš„å¯¼å…¥éƒ¨åˆ†æ·»åŠ ï¼ˆå¦‚æœè¿˜æ²¡æœ‰çš„è¯ï¼‰ï¼š
# from pages import system_management  # åœ¨éœ€è¦æ—¶å¯¼å…¥

def main():
    """ä¸»å‡½æ•°"""
    init_session_state()
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
    if not st.session_state.get('logged_in', False):
        show_login()
        return
    
    # æ˜¾ç¤ºä¾§è¾¹æ 
    show_sidebar()
    
    # æ ¹æ®å½“å‰é¡µé¢æ˜¾ç¤ºç›¸åº”å†…å®¹
    current_page = st.session_state.get('current_page', 'dashboard')
    
    try:
        if current_page == 'dashboard':
            show_dashboard()
        elif current_page == 'mold_management':
            mold_management.show()
        elif current_page == 'mold_query':
            show_mold_query()
        elif current_page == 'loan_management':
            loan_management.show()
        elif current_page == 'maintenance_management':
            maintenance_management.show()
        elif current_page == 'system_management':
            show_system_management()
        else:
            st.error(f"æœªçŸ¥é¡µé¢: {current_page}")
            show_dashboard()
    
    except Exception as e:
        st.error(f"é¡µé¢åŠ è½½å¤±è´¥: {e}")
        st.exception(e)
        
        # æä¾›è¿”å›ä¸»é¡µçš„é€‰é¡¹
        if st.button("ğŸ  è¿”å›ä¸»é¡µ"):
            st.session_state.current_page = 'dashboard'
            st.rerun()

if __name__ == "__main__":
    main()