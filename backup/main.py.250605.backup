# main.py - ä¿®å¤ç‰ˆæœ¬
import streamlit as st
import sys
import os
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
project_root = Path(__file__).parent
sys.path.append(str(project_root))

# å®‰å…¨å¯¼å…¥é¡µé¢æ¨¡å—
def safe_import_modules():
    """å®‰å…¨å¯¼å…¥æ‰€æœ‰é¡µé¢æ¨¡å—"""
    modules = {}
    
    try:
        from pages import mold_management
        modules['mold_management'] = mold_management
        st.sidebar.success("âœ… æ¨¡å…·ç®¡ç†æ¨¡å—å·²åŠ è½½")
    except ImportError as e:
        st.sidebar.error(f"âŒ æ¨¡å…·ç®¡ç†æ¨¡å—åŠ è½½å¤±è´¥: {e}")
        modules['mold_management'] = None
    
    try:
        from pages import loan_management
        modules['loan_management'] = loan_management
        st.sidebar.success("âœ… å€Ÿç”¨ç®¡ç†æ¨¡å—å·²åŠ è½½")
    except ImportError as e:
        st.sidebar.error(f"âŒ å€Ÿç”¨ç®¡ç†æ¨¡å—åŠ è½½å¤±è´¥: {e}")
        modules['loan_management'] = None
    
    try:
        from pages import maintenance_management
        modules['maintenance_management'] = maintenance_management
        st.sidebar.success("âœ… ç»´ä¿®ä¿å…»æ¨¡å—å·²åŠ è½½")
    except ImportError as e:
        st.sidebar.error(f"âŒ ç»´ä¿®ä¿å…»æ¨¡å—åŠ è½½å¤±è´¥: {e}")
        modules['maintenance_management'] = None
    
    return modules

# å¯¼å…¥å·¥å…·æ¨¡å—
try:
    from utils.database import test_connection
    from utils.auth import authenticate_user, logout_user
except ImportError as e:
    st.error(f"å·¥å…·æ¨¡å—å¯¼å…¥å¤±è´¥: {e}")
    st.stop()

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="è•´æ°é‡‘å±æ¨¡å…·ç®¡ç†ç³»ç»Ÿ",
    page_icon="ğŸ”§",
    layout="wide",
    initial_sidebar_state="expanded"
)

# è‡ªå®šä¹‰CSSæ ·å¼
st.markdown("""
<style>
    .main-header {
        padding: 1rem 0;
        background: linear-gradient(90deg, #1f77b4, #ff7f0e);
        color: white;
        text-align: center;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    
    .metric-card {
        background: #f0f2f6;
        padding: 1rem;
        border-radius: 10px;
        border-left: 4px solid #1f77b4;
    }
    
    .sidebar .sidebar-content {
        background: linear-gradient(180deg, #f0f2f6, #ffffff);
    }
    
    .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .status-available { background-color: #28a745; }
    .status-in-use { background-color: #ffc107; }
    .status-maintenance { background-color: #dc3545; }
    
    .quick-action-btn {
        width: 100%;
        margin: 0.25rem 0;
        padding: 0.5rem;
        border-radius: 5px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .quick-action-btn:hover {
        background: #f8f9fa;
        border-color: #1f77b4;
    }
    
    .error-container {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 5px;
        padding: 1rem;
        margin: 1rem 0;
    }
</style>
""", unsafe_allow_html=True)

def show_login_page():
    """æ˜¾ç¤ºç™»å½•é¡µé¢"""
    # å±…ä¸­æ˜¾ç¤ºç™»å½•è¡¨å•
    col1, col2, col3 = st.columns([1, 2, 1])
    
    with col2:
        st.markdown("""
        <div style="text-align: center; padding: 2rem;">
            <h1>ğŸ”§ è•´æ°é‡‘å±æ¨¡å…·ç®¡ç†ç³»ç»Ÿ</h1>
            <p style="color: #666; font-size: 1.1em;">Metal Stamping Die Management System</p>
        </div>
        """, unsafe_allow_html=True)
        
        # ç™»å½•è¡¨å•
        with st.form("login_form"):
            st.markdown("### ğŸ” ç”¨æˆ·ç™»å½•")
            
            username = st.text_input("ç”¨æˆ·å", placeholder="è¯·è¾“å…¥ç”¨æˆ·å")
            password = st.text_input("å¯†ç ", type="password", placeholder="è¯·è¾“å…¥å¯†ç ")
            
            col1, col2 = st.columns(2)
            with col1:
                login_button = st.form_submit_button("ç™»å½•", type="primary", use_container_width=True)
            with col2:
                if st.form_submit_button("æµ‹è¯•è¿æ¥", use_container_width=True):
                    if test_connection():
                        st.success("âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸")
                    else:
                        st.error("âŒ æ•°æ®åº“è¿æ¥å¤±è´¥")
            
            if login_button:
                if username and password:
                    user_info = authenticate_user(username, password)
                    if user_info:
                        # ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°session
                        st.session_state.logged_in = True
                        st.session_state.user_id = user_info['user_id']
                        st.session_state.username = user_info['username']
                        st.session_state.full_name = user_info['full_name']
                        st.session_state.user_role = user_info['role_name']
                        st.success(f"æ¬¢è¿ï¼Œ{user_info['full_name']}ï¼")
                        st.rerun()
                    else:
                        st.error("âŒ ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯")
                else:
                    st.warning("âš ï¸ è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ")
        
        # æ·»åŠ é»˜è®¤è´¦æˆ·è¯´æ˜
        with st.expander("ğŸ’¡ é»˜è®¤æµ‹è¯•è´¦æˆ·", expanded=False):
            st.markdown("""
            **æµ‹è¯•è´¦æˆ·ä¿¡æ¯:**
            
            ğŸ”§ **è¶…çº§ç®¡ç†å‘˜**
            - ç”¨æˆ·å: `admin` 
            - å¯†ç : `admin123`
            
            ğŸ“‹ **æ¨¡å…·åº“ç®¡ç†å‘˜**
            - ç”¨æˆ·å: `mold_admin` 
            - å¯†ç : `mold123`
            
            ğŸ› ï¸ **æ¨¡å…·å·¥**
            - ç”¨æˆ·å: `technician` 
            - å¯†ç : `tech123`
            
            âš¡ **å†²å‹æ“ä½œå·¥**
            - ç”¨æˆ·å: `operator` 
            - å¯†ç : `op123`
            
            *æ³¨: é¦–æ¬¡ä½¿ç”¨å‰è¯·ç¡®ä¿å·²è¿è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬*
            """)

def show_sidebar(modules):
    """æ˜¾ç¤ºä¾§è¾¹æ å¯¼èˆª"""
    with st.sidebar:
        # ç”¨æˆ·ä¿¡æ¯
        st.markdown(f"""
        <div style="padding: 1rem; background: #f0f8ff; border-radius: 10px; margin-bottom: 1rem;">
            <h4>ğŸ‘¤ {st.session_state.full_name}</h4>
            <p style="margin: 0; color: #666;">
                è§’è‰²: {st.session_state.user_role}<br>
                ç”¨æˆ·å: {st.session_state.username}
            </p>
        </div>
        """, unsafe_allow_html=True)
        
        # æ¨¡å—åŠ è½½çŠ¶æ€
        with st.expander("ğŸ“Š ç³»ç»ŸçŠ¶æ€", expanded=False):
            total_modules = len(modules)
            loaded_modules = sum(1 for module in modules.values() if module is not None)
            st.write(f"æ¨¡å—åŠ è½½çŠ¶æ€: {loaded_modules}/{total_modules}")
            
            for name, module in modules.items():
                status = "âœ…" if module else "âŒ"
                display_name = name.replace('_', ' ').title()
                st.write(f"{status} {display_name}")
        
        # å¿«é€Ÿæ“ä½œ
        st.markdown("### âš¡ å¿«é€Ÿæ“ä½œ")
        
        user_role = st.session_state.get('user_role', '')
        
        # æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒçš„å¿«é€Ÿæ“ä½œ
        if user_role in ['è¶…çº§ç®¡ç†å‘˜', 'æ¨¡å…·åº“ç®¡ç†å‘˜']:
            if modules['mold_management']:
                if st.button("ğŸ“‹ æŸ¥çœ‹æ¨¡å…·åˆ—è¡¨", use_container_width=True):
                    st.session_state.current_page = "æ¨¡å…·ç®¡ç†"
                    st.rerun()
            
            if modules['loan_management']:
                if st.button("ğŸ“‹ å€Ÿç”¨ç®¡ç†", use_container_width=True):
                    st.session_state.current_page = "å€Ÿç”¨ç®¡ç†"
                    st.rerun()
            
            if modules['maintenance_management']:
                if st.button("ğŸ”§ ç»´ä¿®ç®¡ç†", use_container_width=True):
                    st.session_state.current_page = "ç»´ä¿®ä¿å…»"
                    st.rerun()
        
        elif user_role == 'æ¨¡å…·å·¥':
            if modules['maintenance_management']:
                if st.button("ğŸ”§ ç»´ä¿®æ¦‚è§ˆ", use_container_width=True):
                    st.session_state.current_page = "ç»´ä¿®ä¿å…»"
                    st.rerun()
        
        elif user_role == 'å†²å‹æ“ä½œå·¥':
            if modules['mold_management']:
                if st.button("ğŸ” æ¨¡å…·æŸ¥è¯¢", use_container_width=True):
                    st.session_state.current_page = "æ¨¡å…·æŸ¥è¯¢"
                    st.rerun()
            
            if modules['loan_management']:
                if st.button("ğŸ“ å€Ÿç”¨ç”³è¯·", use_container_width=True):
                    st.session_state.current_page = "å€Ÿç”¨ç®¡ç†"
                    st.rerun()
        
        st.markdown("---")
        
        # å¯¼èˆªèœå•
        st.markdown("### ğŸ“‚ åŠŸèƒ½å¯¼èˆª")
        
        # æ ¹æ®è§’è‰²å’Œæ¨¡å—å¯ç”¨æ€§æ˜¾ç¤ºä¸åŒçš„å¯¼èˆªé€‰é¡¹
        available_pages = {}
        
        if user_role in ['è¶…çº§ç®¡ç†å‘˜', 'æ¨¡å…·åº“ç®¡ç†å‘˜']:
            available_pages["ğŸ  é¦–é¡µ"] = "é¦–é¡µ"
            
            if modules['mold_management']:
                available_pages["ğŸ“‹ æ¨¡å…·ç®¡ç†"] = "æ¨¡å…·ç®¡ç†"
            
            if modules['loan_management']:
                available_pages["ğŸ› ï¸ å€Ÿç”¨ç®¡ç†"] = "å€Ÿç”¨ç®¡ç†"
            
            if modules['maintenance_management']:
                available_pages["ğŸ”§ ç»´ä¿®ä¿å…»"] = "ç»´ä¿®ä¿å…»"
            
            available_pages["ğŸ“Š ç»Ÿè®¡æŠ¥è¡¨"] = "ç»Ÿè®¡æŠ¥è¡¨"
            available_pages["âš™ï¸ ç³»ç»Ÿç®¡ç†"] = "ç³»ç»Ÿç®¡ç†"
            
        elif user_role == 'æ¨¡å…·å·¥':
            available_pages["ğŸ  é¦–é¡µ"] = "é¦–é¡µ"
            
            if modules['mold_management']:
                available_pages["ğŸ“‹ æ¨¡å…·æŸ¥è¯¢"] = "æ¨¡å…·æŸ¥è¯¢"
            
            if modules['maintenance_management']:
                available_pages["ğŸ”§ ç»´ä¿®ä¿å…»"] = "ç»´ä¿®ä¿å…»"
                
        elif user_role == 'å†²å‹æ“ä½œå·¥':
            available_pages["ğŸ  é¦–é¡µ"] = "é¦–é¡µ"
            
            if modules['mold_management']:
                available_pages["ğŸ” æ¨¡å…·æŸ¥è¯¢"] = "æ¨¡å…·æŸ¥è¯¢"
            
            if modules['loan_management']:
                available_pages["ğŸ› ï¸ å€Ÿç”¨ç®¡ç†"] = "å€Ÿç”¨ç®¡ç†"
        else:
            available_pages = {"ğŸ  é¦–é¡µ": "é¦–é¡µ"}
        
        # æ˜¾ç¤ºå¯¼èˆªæŒ‰é’®
        for page_label, page_name in available_pages.items():
            if st.button(page_label, use_container_width=True):
                st.session_state.current_page = page_name
                st.rerun()
        
        st.markdown("---")
        
        # ç³»ç»Ÿä¿¡æ¯
        st.markdown("### â„¹ï¸ ç³»ç»Ÿä¿¡æ¯")
        st.info(f"""
        **ç³»ç»Ÿç‰ˆæœ¬:** v1.0.0  
        **æ•°æ®åº“:** PostgreSQL  
        **æ¡†æ¶:** Streamlit  
        **éƒ¨ç½²æ–¹å¼:** Docker
        """)
        
        # é€€å‡ºç™»å½•
        if st.button("ğŸšª é€€å‡ºç™»å½•", type="secondary", use_container_width=True):
            logout_user()
            st.rerun()

def show_home_page():
    """æ˜¾ç¤ºé¦–é¡µ"""
    # ä¸»æ ‡é¢˜
    st.markdown("""
    <div class="main-header">
        <h1>ğŸ”§ è•´æ°é‡‘å±å†²å‹æ¨¡å…·ç®¡ç†ç³»ç»Ÿ</h1>
        <p>Metal Stamping Die Management System</p>
    </div>
    """, unsafe_allow_html=True)
    
    user_role = st.session_state.get('user_role', '')
    
    # æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒçš„é¦–é¡µå†…å®¹
    if user_role in ['è¶…çº§ç®¡ç†å‘˜', 'æ¨¡å…·åº“ç®¡ç†å‘˜']:
        show_admin_dashboard()
    elif user_role == 'æ¨¡å…·å·¥':
        show_technician_dashboard()
    elif user_role == 'å†²å‹æ“ä½œå·¥':
        show_operator_dashboard()
    else:
        st.warning("æœªçŸ¥ç”¨æˆ·è§’è‰²")

def show_admin_dashboard():
    """ç®¡ç†å‘˜ä»ªè¡¨æ¿"""
    st.subheader("ğŸ“Š ç®¡ç†æ¦‚è§ˆ")
    
    try:
        from utils.database import execute_query
        
        # ç®€åŒ–çš„ç»Ÿè®¡ä¿¡æ¯
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric("ç³»ç»ŸçŠ¶æ€", "è¿è¡Œä¸­", help="ç³»ç»Ÿè¿è¡ŒçŠ¶æ€")
        
        with col2:
            st.metric("åœ¨çº¿ç”¨æˆ·", "1", help="å½“å‰åœ¨çº¿ç”¨æˆ·æ•°")
        
        with col3:
            st.metric("æ•°æ®åº“", "æ­£å¸¸", help="æ•°æ®åº“è¿æ¥çŠ¶æ€")
        
        with col4:
            st.metric("æœåŠ¡", "å¯ç”¨", help="æœåŠ¡å¯ç”¨æ€§çŠ¶æ€")
        
        # åŠŸèƒ½è¯´æ˜
        st.markdown("---")
        st.subheader("ğŸ“‹ ç³»ç»ŸåŠŸèƒ½")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.markdown("""
            **ğŸ“‹ æ¨¡å…·ç®¡ç†**
            - æ¨¡å…·ä¿¡æ¯æŸ¥è¯¢
            - æ¨¡å…·çŠ¶æ€ç®¡ç†
            - æ¨¡å…·è¯¦æƒ…å±•ç¤º
            """)
        
        with col2:
            st.markdown("""
            **ğŸ› ï¸ å€Ÿç”¨ç®¡ç†**
            - å€Ÿç”¨ç”³è¯·å¤„ç†
            - å®¡æ‰¹æµç¨‹ç®¡ç†
            - å€Ÿç”¨çŠ¶æ€è·Ÿè¸ª
            """)
        
        with col3:
            st.markdown("""
            **ğŸ”§ ç»´ä¿®ä¿å…»**
            - ç»´ä¿®è®°å½•ç®¡ç†
            - ä¿å…»è®¡åˆ’åˆ¶å®š
            - ç»Ÿè®¡åˆ†ææŠ¥è¡¨
            """)
    
    except Exception as e:
        st.error(f"åŠ è½½ä»ªè¡¨æ¿æ•°æ®å¤±è´¥: {e}")

def show_technician_dashboard():
    """æ¨¡å…·å·¥ä»ªè¡¨æ¿"""
    st.subheader("ğŸ”§ ç»´ä¿®å·¥ä½œå°")
    
    st.info("æ¬¢è¿ä½¿ç”¨ç»´ä¿®å·¥ä½œå°ï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡Œç®¡ç†ç»´ä¿®ä¿å…»ä»»åŠ¡ã€‚")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.metric("å¾…å¤„ç†ä»»åŠ¡", "0", help="å½“å‰å¾…å¤„ç†çš„ç»´ä¿®ä»»åŠ¡")
    
    with col2:
        st.metric("æœ¬æœˆå®Œæˆ", "0", help="æœ¬æœˆå®Œæˆçš„ç»´ä¿®ä»»åŠ¡")

def show_operator_dashboard():
    """å†²å‹æ“ä½œå·¥ä»ªè¡¨æ¿"""
    st.subheader("âš¡ æ“ä½œå·¥ä½œå°")
    
    st.info("æ¬¢è¿ä½¿ç”¨æ“ä½œå·¥ä½œå°ï¼Œæ‚¨å¯ä»¥åœ¨è¿™é‡ŒæŸ¥è¯¢æ¨¡å…·ä¿¡æ¯å’Œç”³è¯·å€Ÿç”¨ã€‚")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.metric("æˆ‘çš„ç”³è¯·", "0", help="æˆ‘æäº¤çš„å€Ÿç”¨ç”³è¯·æ•°é‡")
    
    with col2:
        st.metric("å¯ç”¨æ¨¡å…·", "0", help="å½“å‰å¯å€Ÿç”¨çš„æ¨¡å…·æ•°é‡")

def show_module_unavailable(module_name):
    """æ˜¾ç¤ºæ¨¡å—ä¸å¯ç”¨é¡µé¢"""
    st.error(f"âŒ {module_name} æ¨¡å—å½“å‰ä¸å¯ç”¨")
    st.markdown("""
    ### å¯èƒ½çš„åŸå› ï¼š
    1. æ¨¡å—æ–‡ä»¶ä¸å­˜åœ¨æˆ–æœ‰è¯­æ³•é”™è¯¯
    2. ç¼ºå°‘å¿…è¦çš„ä¾èµ–
    3. æ•°æ®åº“è¿æ¥é—®é¢˜
    
    ### è§£å†³æ–¹æ³•ï¼š
    1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼š`pages/{module_name.lower().replace(' ', '_')}.py`
    2. æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯æ—¥å¿—
    3. é‡å¯åº”ç”¨æœåŠ¡
    """)

def main():
    """ä¸»å‡½æ•°"""
    # åˆå§‹åŒ–session state
    if 'logged_in' not in st.session_state:
        st.session_state.logged_in = False
    
    if 'current_page' not in st.session_state:
        st.session_state.current_page = "é¦–é¡µ"
    
    # æ£€æŸ¥ç™»å½•çŠ¶æ€
    if not st.session_state.logged_in:
        show_login_page()
        return
    
    # å®‰å…¨å¯¼å…¥æ¨¡å—
    modules = safe_import_modules()
    
    # æ˜¾ç¤ºä¾§è¾¹æ 
    show_sidebar(modules)
    
    # æ ¹æ®é€‰æ‹©çš„é¡µé¢æ˜¾ç¤ºå†…å®¹
    page = st.session_state.current_page
    
    try:
        if page == "é¦–é¡µ":
            show_home_page()
        
        elif page == "æ¨¡å…·ç®¡ç†":
            if modules['mold_management']:
                modules['mold_management'].show()
            else:
                show_module_unavailable("æ¨¡å…·ç®¡ç†")
        
        elif page == "æ¨¡å…·æŸ¥è¯¢":
            if modules['mold_management']:
                # ä¸ºå†²å‹æ“ä½œå·¥æä¾›åªè¯»çš„æ¨¡å…·æŸ¥è¯¢ç•Œé¢
                if hasattr(modules['mold_management'], 'show_mold_list_readonly'):
                    modules['mold_management'].show_mold_list_readonly()
                else:
                    modules['mold_management'].show()
            else:
                show_module_unavailable("æ¨¡å…·æŸ¥è¯¢")
        
        elif page == "å€Ÿç”¨ç®¡ç†":
            if modules['loan_management']:
                modules['loan_management'].show()
            else:
                show_module_unavailable("å€Ÿç”¨ç®¡ç†")
        
        elif page == "ç»´ä¿®ä¿å…»":
            if modules['maintenance_management']:
                modules['maintenance_management'].show()
            else:
                show_module_unavailable("ç»´ä¿®ä¿å…»")
        
        elif page == "ç»Ÿè®¡æŠ¥è¡¨":
            st.title("ğŸ“Š ç»Ÿè®¡æŠ¥è¡¨")
            st.info("ç»Ÿè®¡æŠ¥è¡¨æ¨¡å—å¼€å‘ä¸­...")
        
        elif page == "ç³»ç»Ÿç®¡ç†":
            st.title("âš™ï¸ ç³»ç»Ÿç®¡ç†")
            st.info("ç³»ç»Ÿç®¡ç†æ¨¡å—å¼€å‘ä¸­...")
        
        else:
            st.error(f"é¡µé¢ '{page}' ä¸å­˜åœ¨")
            st.session_state.current_page = "é¦–é¡µ"
            st.rerun()
    
    except Exception as e:
        st.error(f"é¡µé¢åŠ è½½å¤±è´¥: {e}")
        st.exception(e)

if __name__ == "__main__":
    main()