# pages/loan_management.py
import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime, timedelta
from utils.database import (
    execute_query, get_all_molds, get_mold_by_id,
    get_loan_statuses, get_users, convert_numpy_types
)

def create_loan_application():
    """åˆ›å»ºå€Ÿç”¨ç”³è¯·"""
    st.subheader("ğŸ“ æ–°å»ºå€Ÿç”¨ç”³è¯·")
    
    # è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    current_user_id = st.session_state.get('user_id')
    current_user_role = st.session_state.get('user_role')
    
    # è·å–å¯å€Ÿç”¨çš„æ¨¡å…·ï¼ˆçŠ¶æ€ä¸ºé—²ç½®çš„ï¼‰
    query = """
    SELECT 
        m.mold_id,
        m.mold_code,
        m.mold_name,
        mft.type_name as functional_type,
        ms.status_name as current_status,
        sl.location_name as current_location
    FROM molds m
    LEFT JOIN mold_functional_types mft ON m.mold_functional_type_id = mft.type_id
    LEFT JOIN mold_statuses ms ON m.current_status_id = ms.status_id
    LEFT JOIN storage_locations sl ON m.current_location_id = sl.location_id
    WHERE ms.status_name = 'é—²ç½®'
    ORDER BY m.mold_code
    """
    
    available_molds = execute_query(query)
    
    if not available_molds:
        st.warning("å½“å‰æ²¡æœ‰å¯å€Ÿç”¨çš„æ¨¡å…·")
        return
    
    # åˆ›å»ºç”³è¯·è¡¨å•
    with st.form("loan_application_form"):
        col1, col2 = st.columns(2)
        
        with col1:
            # é€‰æ‹©æ¨¡å…·
            mold_options = {f"{m['mold_code']} - {m['mold_name']}": m['mold_id'] 
                          for m in available_molds}
            selected_mold = st.selectbox(
                "é€‰æ‹©æ¨¡å…·",
                options=list(mold_options.keys()),
                help="åªæ˜¾ç¤ºå½“å‰é—²ç½®çŠ¶æ€çš„æ¨¡å…·"
            )
            
            # ä½¿ç”¨è®¾å¤‡
            destination_equipment = st.text_input(
                "ä½¿ç”¨è®¾å¤‡",
                placeholder="è¯·è¾“å…¥è®¾å¤‡ç¼–å·æˆ–åç§°"
            )
            
        with col2:
            # é¢„è®¡ä½¿ç”¨æ—¶é•¿
            use_duration = st.selectbox(
                "é¢„è®¡ä½¿ç”¨æ—¶é•¿",
                options=["4å°æ—¶", "8å°æ—¶", "1å¤©", "2å¤©", "3å¤©", "1å‘¨", "å…¶ä»–"],
                index=1
            )
            
            # å¦‚æœé€‰æ‹©å…¶ä»–ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥
            if use_duration == "å…¶ä»–":
                custom_days = st.number_input("è‡ªå®šä¹‰å¤©æ•°", min_value=1, max_value=30, value=1)
                expected_return = datetime.now() + timedelta(days=custom_days)
            else:
                # æ ¹æ®é€‰æ‹©è®¡ç®—é¢„è®¡å½’è¿˜æ—¶é—´
                duration_map = {
                    "4å°æ—¶": timedelta(hours=4),
                    "8å°æ—¶": timedelta(hours=8),
                    "1å¤©": timedelta(days=1),
                    "2å¤©": timedelta(days=2),
                    "3å¤©": timedelta(days=3),
                    "1å‘¨": timedelta(days=7)
                }
                expected_return = datetime.now() + duration_map.get(use_duration, timedelta(days=1))
            
            # æ˜¾ç¤ºé¢„è®¡å½’è¿˜æ—¶é—´
            st.date_input("é¢„è®¡å½’è¿˜æ—¥æœŸ", value=expected_return.date(), disabled=True)
        
        # ç”Ÿäº§ä»»åŠ¡è¯´æ˜
        production_task = st.text_area(
            "ç”Ÿäº§ä»»åŠ¡è¯´æ˜",
            placeholder="è¯·æè¿°ç”Ÿäº§ä»»åŠ¡ã€äº§å“ä¿¡æ¯ã€é¢„è®¡ç”Ÿäº§æ•°é‡ç­‰",
            height=100
        )
        
        # å¤‡æ³¨
        remarks = st.text_area(
            "å¤‡æ³¨",
            placeholder="å…¶ä»–éœ€è¦è¯´æ˜çš„ä¿¡æ¯",
            height=60
        )
        
        # æäº¤æŒ‰é’®
        submitted = st.form_submit_button("æäº¤ç”³è¯·", type="primary", use_container_width=True)
        
        if submitted:
            if not destination_equipment:
                st.error("è¯·å¡«å†™ä½¿ç”¨è®¾å¤‡")
            elif not production_task:
                st.error("è¯·å¡«å†™ç”Ÿäº§ä»»åŠ¡è¯´æ˜")
            else:
                # æäº¤ç”³è¯·åˆ°æ•°æ®åº“
                mold_id = convert_numpy_types(mold_options[selected_mold])
                
                # è·å–å¾…å®¡æ‰¹çŠ¶æ€ID
                status_query = "SELECT status_id FROM loan_statuses WHERE status_name = 'å¾…å®¡æ‰¹'"
                status_result = execute_query(status_query)
                if not status_result:
                    st.error("ç³»ç»Ÿé”™è¯¯ï¼šæ‰¾ä¸åˆ°å€Ÿç”¨çŠ¶æ€")
                    return
                
                status_id = status_result[0]['status_id']
                
                # æ’å…¥å€Ÿç”¨è®°å½•
                insert_query = """
                INSERT INTO mold_loan_records (
                    mold_id, applicant_id, application_timestamp,
                    expected_return_timestamp, loan_status_id,
                    destination_equipment, remarks
                ) VALUES (%s, %s, NOW(), %s, %s, %s, %s)
                RETURNING loan_id
                """
                
                combined_remarks = f"ç”Ÿäº§ä»»åŠ¡: {production_task}"
                if remarks:
                    combined_remarks += f"\nå¤‡æ³¨: {remarks}"
                
                params = (
                    mold_id,
                    current_user_id,
                    expected_return,
                    status_id,
                    destination_equipment,
                    combined_remarks
                )
                
                result = execute_query(insert_query, params)
                
                if result:
                    st.success(f"âœ… å€Ÿç”¨ç”³è¯·å·²æäº¤ï¼Œç”³è¯·ç¼–å·ï¼š{result[0]['loan_id']}")
                    st.balloons()
                    # æ¸…ç©ºè¡¨å•
                    st.rerun()
                else:
                    st.error("æäº¤ç”³è¯·å¤±è´¥ï¼Œè¯·é‡è¯•")

def show_loan_approvals():
    """æ˜¾ç¤ºå¾…å®¡æ‰¹çš„å€Ÿç”¨ç”³è¯·"""
    st.subheader("ğŸ“‹ å¾…å®¡æ‰¹ç”³è¯·")
    
    # è·å–å¾…å®¡æ‰¹çš„ç”³è¯·
    query = """
    SELECT 
        mlr.loan_id,
        m.mold_code,
        m.mold_name,
        u.full_name as applicant_name,
        mlr.application_timestamp,
        mlr.expected_return_timestamp,
        mlr.destination_equipment,
        mlr.remarks,
        sl.location_name as current_location
    FROM mold_loan_records mlr
    JOIN molds m ON mlr.mold_id = m.mold_id
    JOIN users u ON mlr.applicant_id = u.user_id
    JOIN loan_statuses ls ON mlr.loan_status_id = ls.status_id
    LEFT JOIN storage_locations sl ON m.current_location_id = sl.location_id
    WHERE ls.status_name = 'å¾…å®¡æ‰¹'
    ORDER BY mlr.application_timestamp ASC
    """
    
    pending_loans = execute_query(query)
    
    if not pending_loans:
        st.info("å½“å‰æ²¡æœ‰å¾…å®¡æ‰¹çš„ç”³è¯·")
        return
    
    # æ˜¾ç¤ºå¾…å®¡æ‰¹åˆ—è¡¨
    for loan in pending_loans:
        with st.expander(f"ç”³è¯· #{loan['loan_id']} - {loan['mold_code']} - {loan['mold_name']}", expanded=True):
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.write(f"**ç”³è¯·äººï¼š** {loan['applicant_name']}")
                st.write(f"**ç”³è¯·æ—¶é—´ï¼š** {loan['application_timestamp'].strftime('%Y-%m-%d %H:%M')}")
                st.write(f"**ä½¿ç”¨è®¾å¤‡ï¼š** {loan['destination_equipment']}")
            
            with col2:
                st.write(f"**é¢„è®¡å½’è¿˜ï¼š** {loan['expected_return_timestamp'].strftime('%Y-%m-%d')}")
                st.write(f"**æ¨¡å…·ä½ç½®ï¼š** {loan['current_location']}")
                
                # è®¡ç®—å€Ÿç”¨å¤©æ•°
                days = (loan['expected_return_timestamp'] - loan['application_timestamp']).days
                st.write(f"**å€Ÿç”¨å¤©æ•°ï¼š** {days} å¤©")
            
            with col3:
                st.write("**ç”³è¯·è¯´æ˜ï¼š**")
                st.text(loan['remarks'] or "æ— ")
            
            # å®¡æ‰¹æ“ä½œ
            col1, col2, col3 = st.columns([1, 1, 3])
            
            with col1:
                if st.button("âœ… æ‰¹å‡†", key=f"approve_{loan['loan_id']}", type="primary"):
                    approve_loan(loan['loan_id'])
                    st.rerun()
            
            with col2:
                if st.button("âŒ é©³å›", key=f"reject_{loan['loan_id']}"):
                    reject_loan(loan['loan_id'])
                    st.rerun()

def approve_loan(loan_id):
    """æ‰¹å‡†å€Ÿç”¨ç”³è¯·"""
    try:
        # è·å–å½“å‰å®¡æ‰¹äººID
        approver_id = st.session_state.get('user_id')
        
        # æ›´æ–°å€Ÿç”¨è®°å½•çŠ¶æ€ä¸ºå·²æ‰¹å‡†
        update_query = """
        UPDATE mold_loan_records
        SET loan_status_id = (SELECT status_id FROM loan_statuses WHERE status_name = 'å·²æ‰¹å‡†'),
            approver_id = %s,
            approval_timestamp = NOW()
        WHERE loan_id = %s
        """
        
        result = execute_query(update_query, (approver_id, loan_id), fetch=False)
        
        if result:
            st.success("âœ… ç”³è¯·å·²æ‰¹å‡†")
        else:
            st.error("æ‰¹å‡†æ“ä½œå¤±è´¥")
            
    except Exception as e:
        st.error(f"æ‰¹å‡†æ“ä½œå¤±è´¥: {e}")

def reject_loan(loan_id):
    """é©³å›å€Ÿç”¨ç”³è¯·"""
    try:
        # è·å–å½“å‰å®¡æ‰¹äººID
        approver_id = st.session_state.get('user_id')
        
        # å¼¹å‡ºé©³å›åŸå› è¾“å…¥æ¡†
        reason = st.text_input(f"é©³å›åŸå›  (ç”³è¯·#{loan_id})", key=f"reject_reason_{loan_id}")
        
        if st.button(f"ç¡®è®¤é©³å›", key=f"confirm_reject_{loan_id}"):
            if not reason:
                st.error("è¯·è¾“å…¥é©³å›åŸå› ")
                return
            
            # æ›´æ–°å€Ÿç”¨è®°å½•çŠ¶æ€ä¸ºå·²é©³å›
            update_query = """
            UPDATE mold_loan_records
            SET loan_status_id = (SELECT status_id FROM loan_statuses WHERE status_name = 'å·²é©³å›'),
                approver_id = %s,
                approval_timestamp = NOW(),
                remarks = CONCAT(remarks, '\né©³å›åŸå› : ', %s)
            WHERE loan_id = %s
            """
            
            result = execute_query(update_query, (approver_id, reason, loan_id), fetch=False)
            
            if result:
                st.success("âœ… ç”³è¯·å·²é©³å›")
                st.rerun()
            else:
                st.error("é©³å›æ“ä½œå¤±è´¥")
                
    except Exception as e:
        st.error(f"é©³å›æ“ä½œå¤±è´¥: {e}")

def show_approved_loans():
    """æ˜¾ç¤ºå·²æ‰¹å‡†å¾…é¢†ç”¨çš„ç”³è¯·"""
    st.subheader("ğŸ“¦ å¾…é¢†ç”¨æ¨¡å…·")
    
    query = """
    SELECT 
        mlr.loan_id,
        mlr.mold_id,
        m.mold_code,
        m.mold_name,
        u.full_name as applicant_name,
        mlr.approval_timestamp,
        mlr.expected_return_timestamp,
        mlr.destination_equipment,
        sl.location_name as current_location
    FROM mold_loan_records mlr
    JOIN molds m ON mlr.mold_id = m.mold_id
    JOIN users u ON mlr.applicant_id = u.user_id
    JOIN loan_statuses ls ON mlr.loan_status_id = ls.status_id
    LEFT JOIN storage_locations sl ON m.current_location_id = sl.location_id
    WHERE ls.status_name = 'å·²æ‰¹å‡†'
    ORDER BY mlr.approval_timestamp ASC
    """
    
    approved_loans = execute_query(query)
    
    if not approved_loans:
        st.info("å½“å‰æ²¡æœ‰å¾…é¢†ç”¨çš„æ¨¡å…·")
        return
    
    # æ˜¾ç¤ºå¾…é¢†ç”¨åˆ—è¡¨
    for loan in approved_loans:
        with st.expander(f"é¢†ç”¨å• #{loan['loan_id']} - {loan['mold_code']} - {loan['mold_name']}"):
            col1, col2 = st.columns(2)
            
            with col1:
                st.write(f"**ç”³è¯·äººï¼š** {loan['applicant_name']}")
                st.write(f"**æ‰¹å‡†æ—¶é—´ï¼š** {loan['approval_timestamp'].strftime('%Y-%m-%d %H:%M')}")
                st.write(f"**ä½¿ç”¨è®¾å¤‡ï¼š** {loan['destination_equipment']}")
            
            with col2:
                st.write(f"**é¢„è®¡å½’è¿˜ï¼š** {loan['expected_return_timestamp'].strftime('%Y-%m-%d')}")
                st.write(f"**æ¨¡å…·ä½ç½®ï¼š** {loan['current_location']}")
            
            # å‘æ”¾æ“ä½œ
            if st.button(f"âœ… ç¡®è®¤å‘æ”¾", key=f"issue_{loan['loan_id']}", type="primary"):
                issue_mold(loan['loan_id'], loan['mold_id'])
                st.rerun()

def issue_mold(loan_id, mold_id):
    """å‘æ”¾æ¨¡å…·"""
    try:
        # å¼€å§‹äº‹åŠ¡
        # 1. æ›´æ–°å€Ÿç”¨è®°å½•çŠ¶æ€ä¸ºå·²é¢†ç”¨
        update_loan_query = """
        UPDATE mold_loan_records
        SET loan_status_id = (SELECT status_id FROM loan_statuses WHERE status_name = 'å·²é¢†ç”¨'),
            loan_out_timestamp = NOW()
        WHERE loan_id = %s
        """
        
        # 2. æ›´æ–°æ¨¡å…·çŠ¶æ€ä¸ºå·²å€Ÿå‡º
        update_mold_query = """
        UPDATE molds
        SET current_status_id = (SELECT status_id FROM mold_statuses WHERE status_name = 'å·²å€Ÿå‡º'),
            updated_at = NOW()
        WHERE mold_id = %s
        """
        
        # æ‰§è¡Œæ›´æ–°
        loan_result = execute_query(update_loan_query, (loan_id,), fetch=False)
        mold_result = execute_query(update_mold_query, (convert_numpy_types(mold_id),), fetch=False)
        
        if loan_result and mold_result:
            st.success("âœ… æ¨¡å…·å·²å‘æ”¾")
        else:
            st.error("å‘æ”¾æ“ä½œå¤±è´¥")
            
    except Exception as e:
        st.error(f"å‘æ”¾æ“ä½œå¤±è´¥: {e}")

def show_borrowed_molds():
    """æ˜¾ç¤ºå·²å€Ÿå‡ºçš„æ¨¡å…·"""
    st.subheader("ğŸ“¤ å·²å€Ÿå‡ºæ¨¡å…·")
    
    query = """
    SELECT 
        mlr.loan_id,
        mlr.mold_id,
        m.mold_code,
        m.mold_name,
        u.full_name as borrower_name,
        mlr.loan_out_timestamp,
        mlr.expected_return_timestamp,
        mlr.destination_equipment,
        CASE 
            WHEN mlr.expected_return_timestamp < NOW() THEN 'é€¾æœŸ'
            ELSE 'æ­£å¸¸'
        END as status
    FROM mold_loan_records mlr
    JOIN molds m ON mlr.mold_id = m.mold_id
    JOIN users u ON mlr.applicant_id = u.user_id
    JOIN loan_statuses ls ON mlr.loan_status_id = ls.status_id
    WHERE ls.status_name = 'å·²é¢†ç”¨'
    ORDER BY mlr.expected_return_timestamp ASC
    """
    
    borrowed_molds = execute_query(query)
    
    if not borrowed_molds:
        st.info("å½“å‰æ²¡æœ‰å€Ÿå‡ºçš„æ¨¡å…·")
        return
    
    # ç»Ÿè®¡ä¿¡æ¯
    total_borrowed = len(borrowed_molds)
    overdue_count = len([m for m in borrowed_molds if m['status'] == 'é€¾æœŸ'])
    
    col1, col2 = st.columns(2)
    with col1:
        st.metric("å€Ÿå‡ºæ€»æ•°", total_borrowed)
    with col2:
        st.metric("é€¾æœŸæ•°é‡", overdue_count, delta=None if overdue_count == 0 else f"+{overdue_count}")
    
    # æ˜¾ç¤ºå€Ÿå‡ºåˆ—è¡¨
    for mold in borrowed_molds:
        # æ ¹æ®çŠ¶æ€è®¾ç½®ä¸åŒçš„æ˜¾ç¤ºæ ·å¼
        if mold['status'] == 'é€¾æœŸ':
            with st.expander(f"âš ï¸ ã€é€¾æœŸã€‘{mold['mold_code']} - {mold['mold_name']}", expanded=True):
                display_borrowed_mold_info(mold)
        else:
            with st.expander(f"{mold['mold_code']} - {mold['mold_name']}"):
                display_borrowed_mold_info(mold)

def display_borrowed_mold_info(mold):
    """æ˜¾ç¤ºå€Ÿå‡ºæ¨¡å…·çš„è¯¦ç»†ä¿¡æ¯"""
    col1, col2 = st.columns(2)
    
    with col1:
        st.write(f"**å€Ÿç”¨äººï¼š** {mold['borrower_name']}")
        st.write(f"**å€Ÿå‡ºæ—¶é—´ï¼š** {mold['loan_out_timestamp'].strftime('%Y-%m-%d %H:%M')}")
        st.write(f"**ä½¿ç”¨è®¾å¤‡ï¼š** {mold['destination_equipment']}")
    
    with col2:
        st.write(f"**é¢„è®¡å½’è¿˜ï¼š** {mold['expected_return_timestamp'].strftime('%Y-%m-%d')}")
        
        # è®¡ç®—å·²å€Ÿç”¨å¤©æ•°
        days_borrowed = (datetime.now() - mold['loan_out_timestamp']).days
        st.write(f"**å·²å€Ÿç”¨ï¼š** {days_borrowed} å¤©")
        
        if mold['status'] == 'é€¾æœŸ':
            days_overdue = (datetime.now() - mold['expected_return_timestamp']).days
            st.write(f"**é€¾æœŸå¤©æ•°ï¼š** :red[{days_overdue} å¤©]")
    
    # å½’è¿˜æ“ä½œ
    if st.button(f"ğŸ“¥ åŠç†å½’è¿˜", key=f"return_{mold['loan_id']}"):
        with st.form(f"return_form_{mold['loan_id']}"):
            st.write("### å½’è¿˜ä¿¡æ¯")
            
            col1, col2 = st.columns(2)
            with col1:
                return_status = st.selectbox(
                    "æ¨¡å…·çŠ¶æ€",
                    options=["æ­£å¸¸", "éœ€è¦ä¿å…»", "éœ€è¦ç»´ä¿®", "æœ‰è½»å¾®ç£¨æŸ"],
                    help="è¯·æ£€æŸ¥æ¨¡å…·çŠ¶æ€"
                )
            
            with col2:
                strokes_used = st.number_input(
                    "æœ¬æ¬¡ä½¿ç”¨å†²æ¬¡",
                    min_value=0,
                    value=0,
                    step=100,
                    help="è¯·å¡«å†™æœ¬æ¬¡å®é™…ä½¿ç”¨çš„å†²æ¬¡æ•°"
                )
            
            return_remarks = st.text_area(
                "å½’è¿˜å¤‡æ³¨",
                placeholder="è¯·å¡«å†™æ¨¡å…·ä½¿ç”¨æƒ…å†µã€å‘ç°çš„é—®é¢˜ç­‰"
            )
            
            submitted = st.form_submit_button("ç¡®è®¤å½’è¿˜", type="primary")
            
            if submitted:
                process_mold_return(
                    mold['loan_id'], 
                    mold['mold_id'], 
                    return_status, 
                    strokes_used,
                    return_remarks
                )
                st.rerun()

def process_mold_return(loan_id, mold_id, return_status, strokes_used, remarks):
    """å¤„ç†æ¨¡å…·å½’è¿˜"""
    try:
        # 1. æ›´æ–°å€Ÿç”¨è®°å½•
        update_loan_query = """
        UPDATE mold_loan_records
        SET loan_status_id = (SELECT status_id FROM loan_statuses WHERE status_name = 'å·²å½’è¿˜'),
            actual_return_timestamp = NOW(),
            remarks = CONCAT(COALESCE(remarks, ''), '\nå½’è¿˜ä¿¡æ¯: çŠ¶æ€-', %s, ', ä½¿ç”¨å†²æ¬¡-', %s, '\nå½’è¿˜å¤‡æ³¨: ', %s)
        WHERE loan_id = %s
        """
        
        # 2. æ ¹æ®å½’è¿˜çŠ¶æ€ç¡®å®šæ¨¡å…·æ–°çŠ¶æ€
        mold_status_map = {
            "æ­£å¸¸": "é—²ç½®",
            "éœ€è¦ä¿å…»": "å¾…ä¿å…»",
            "éœ€è¦ç»´ä¿®": "å¾…ç»´ä¿®",
            "æœ‰è½»å¾®ç£¨æŸ": "é—²ç½®"  # è½»å¾®ç£¨æŸä¹Ÿè®¾ä¸ºé—²ç½®ï¼Œä½†ä¼šåœ¨å¤‡æ³¨ä¸­è®°å½•
        }
        new_mold_status = mold_status_map.get(return_status, "é—²ç½®")
        
        # 3. æ›´æ–°æ¨¡å…·çŠ¶æ€å’Œå†²æ¬¡
        update_mold_query = """
        UPDATE molds
        SET current_status_id = (SELECT status_id FROM mold_statuses WHERE status_name = %s),
            accumulated_strokes = accumulated_strokes + %s,
            updated_at = NOW()
        WHERE mold_id = %s
        """
        
        # 4. å¦‚æœæœ‰ä½¿ç”¨å†²æ¬¡ï¼Œæ’å…¥ä½¿ç”¨è®°å½•
        if strokes_used > 0:
            # è·å–å€Ÿç”¨äººIDä½œä¸ºæ“ä½œå·¥ID
            get_operator_query = """
            SELECT applicant_id, destination_equipment 
            FROM mold_loan_records 
            WHERE loan_id = %s
            """
            operator_result = execute_query(get_operator_query, (loan_id,))
            
            if operator_result:
                operator_id = operator_result[0]['applicant_id']
                equipment_id = operator_result[0]['destination_equipment']
                
                insert_usage_query = """
                INSERT INTO mold_usage_records (
                    mold_id, operator_id, equipment_id,
                    start_timestamp, end_timestamp,
                    strokes_this_session, notes
                ) VALUES (
                    %s, %s, %s,
                    (SELECT loan_out_timestamp FROM mold_loan_records WHERE loan_id = %s),
                    NOW(),
                    %s, %s
                )
                """
                
                usage_notes = f"å€Ÿç”¨å½’è¿˜è®°å½• - {remarks}" if remarks else "å€Ÿç”¨å½’è¿˜è®°å½•"
                
                execute_query(
                    insert_usage_query, 
                    (
                        convert_numpy_types(mold_id), 
                        operator_id, 
                        equipment_id,
                        loan_id,
                        strokes_used,
                        usage_notes
                    ),
                    fetch=False
                )
        
        # æ‰§è¡Œæ›´æ–°
        execute_query(
            update_loan_query, 
            (return_status, strokes_used, remarks or "", loan_id),
            fetch=False
        )
        
        execute_query(
            update_mold_query,
            (new_mold_status, strokes_used, convert_numpy_types(mold_id)),
            fetch=False
        )
        
        st.success("âœ… æ¨¡å…·å½’è¿˜æˆåŠŸ")
        
    except Exception as e:
        st.error(f"å½’è¿˜æ“ä½œå¤±è´¥: {e}")

def show_loan_history():
    """æ˜¾ç¤ºå€Ÿç”¨å†å²è®°å½•"""
    st.subheader("ğŸ“Š å€Ÿç”¨å†å²")
    
    # ç­›é€‰æ¡ä»¶
    col1, col2, col3 = st.columns(3)
    
    with col1:
        # æ—¶é—´èŒƒå›´ç­›é€‰
        date_range = st.selectbox(
            "æ—¶é—´èŒƒå›´",
            options=["æœ€è¿‘7å¤©", "æœ€è¿‘30å¤©", "æœ€è¿‘3ä¸ªæœˆ", "å…¨éƒ¨"],
            index=1
        )
    
    with col2:
        # çŠ¶æ€ç­›é€‰
        status_options = ["å…¨éƒ¨"] + [s['status_name'] for s in get_loan_statuses()]
        selected_status = st.selectbox("çŠ¶æ€ç­›é€‰", status_options)
    
    with col3:
        # æœç´¢æ¡†
        search_term = st.text_input("æœç´¢ (æ¨¡å…·ç¼–å·/å€Ÿç”¨äºº)", placeholder="è¾“å…¥å…³é”®è¯")
    
    # æ„å»ºæŸ¥è¯¢æ¡ä»¶
    conditions = []
    params = []
    
    # æ—¶é—´æ¡ä»¶
    if date_range != "å…¨éƒ¨":
        date_map = {
            "æœ€è¿‘7å¤©": 7,
            "æœ€è¿‘30å¤©": 30,
            "æœ€è¿‘3ä¸ªæœˆ": 90
        }
        days = date_map.get(date_range, 30)
        conditions.append("mlr.application_timestamp >= NOW() - INTERVAL '%s days'")
        params.append(days)
    
    # çŠ¶æ€æ¡ä»¶
    if selected_status != "å…¨éƒ¨":
        conditions.append("ls.status_name = %s")
        params.append(selected_status)
    
    # æœç´¢æ¡ä»¶
    if search_term:
        conditions.append("(m.mold_code ILIKE %s OR m.mold_name ILIKE %s OR u.full_name ILIKE %s)")
        params.extend([f"%{search_term}%", f"%{search_term}%", f"%{search_term}%"])
    
    # æ„å»ºæŸ¥è¯¢
    where_clause = " AND ".join(conditions) if conditions else "1=1"
    
    query = f"""
    SELECT 
        mlr.loan_id,
        m.mold_code,
        m.mold_name,
        u.full_name as borrower_name,
        mlr.application_timestamp,
        mlr.loan_out_timestamp,
        mlr.expected_return_timestamp,
        mlr.actual_return_timestamp,
        ls.status_name as loan_status,
        mlr.destination_equipment,
        CASE 
            WHEN mlr.actual_return_timestamp IS NOT NULL THEN
                mlr.actual_return_timestamp - mlr.loan_out_timestamp
            WHEN ls.status_name = 'å·²é¢†ç”¨' THEN
                NOW() - mlr.loan_out_timestamp
            ELSE NULL
        END as usage_duration
    FROM mold_loan_records mlr
    JOIN molds m ON mlr.mold_id = m.mold_id
    JOIN users u ON mlr.applicant_id = u.user_id
    JOIN loan_statuses ls ON mlr.loan_status_id = ls.status_id
    WHERE {where_clause}
    ORDER BY mlr.application_timestamp DESC
    LIMIT 100
    """
    
    records = execute_query(query, params if params else None)
    
    if not records:
        st.info("æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•")
        return
    
    # è½¬æ¢ä¸ºDataFrame
    df = pd.DataFrame(records)
    
    # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("æ€»è®°å½•æ•°", len(df))
    with col2:
        completed = len(df[df['loan_status'] == 'å·²å½’è¿˜'])
        st.metric("å·²å½’è¿˜", completed)
    with col3:
        in_use = len(df[df['loan_status'] == 'å·²é¢†ç”¨'])
        st.metric("ä½¿ç”¨ä¸­", in_use)
    with col4:
        rejected = len(df[df['loan_status'] == 'å·²é©³å›'])
        st.metric("å·²é©³å›", rejected)
    
    # æ˜¾ç¤ºæ•°æ®è¡¨
    st.dataframe(
        df,
        column_config={
            "loan_id": st.column_config.NumberColumn("å€Ÿç”¨ID", width="small"),
            "mold_code": st.column_config.TextColumn("æ¨¡å…·ç¼–å·", width="medium"),
            "mold_name": st.column_config.TextColumn("æ¨¡å…·åç§°", width="medium"),
            "borrower_name": st.column_config.TextColumn("å€Ÿç”¨äºº", width="medium"),
            "application_timestamp": st.column_config.DatetimeColumn("ç”³è¯·æ—¶é—´", width="medium"),
            "loan_out_timestamp": st.column_config.DatetimeColumn("å€Ÿå‡ºæ—¶é—´", width="medium"),
            "actual_return_timestamp": st.column_config.DatetimeColumn("å½’è¿˜æ—¶é—´", width="medium"),
            "loan_status": st.column_config.TextColumn("çŠ¶æ€", width="small"),
            "destination_equipment": st.column_config.TextColumn("ä½¿ç”¨è®¾å¤‡", width="medium"),
            "usage_duration": st.column_config.TextColumn("ä½¿ç”¨æ—¶é•¿", width="medium")
        },
        use_container_width=True,
        hide_index=True
    )

def show():
    """ä¸»å‡½æ•° - æ˜¾ç¤ºå€Ÿç”¨ç®¡ç†é¡µé¢"""
    st.title("ğŸ“¤ å€Ÿç”¨ç®¡ç†")
    
    # è·å–ç”¨æˆ·è§’è‰²
    user_role = st.session_state.get('user_role', '')
    
    # æ ¹æ®è§’è‰²æ˜¾ç¤ºä¸åŒçš„åŠŸèƒ½æ ‡ç­¾
    if user_role == 'å†²å‹æ“ä½œå·¥':
        # æ“ä½œå·¥åªèƒ½ç”³è¯·å€Ÿç”¨å’ŒæŸ¥çœ‹è‡ªå·±çš„è®°å½•
        tab1, tab2 = st.tabs(["ğŸ“ å€Ÿç”¨ç”³è¯·", "ğŸ“Š æˆ‘çš„å€Ÿç”¨è®°å½•"])
        
        with tab1:
            create_loan_application()
        
        with tab2:
            show_my_loan_records()
    
    elif user_role in ['æ¨¡å…·åº“ç®¡ç†å‘˜', 'è¶…çº§ç®¡ç†å‘˜']:
        # ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰åŠŸèƒ½
        tab1, tab2, tab3, tab4, tab5 = st.tabs([
            "ğŸ“ æ–°å»ºç”³è¯·", 
            "ğŸ“‹ å¾…å®¡æ‰¹", 
            "ğŸ“¦ å¾…é¢†ç”¨", 
            "ğŸ“¤ å·²å€Ÿå‡º", 
            "ğŸ“Š å†å²è®°å½•"
        ])
        
        with tab1:
            create_loan_application()
        
        with tab2:
            show_loan_approvals()
        
        with tab3:
            show_approved_loans()
        
        with tab4:
            show_borrowed_molds()
        
        with tab5:
            show_loan_history()
    
    else:
        st.warning("æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤åŠŸèƒ½")

def show_my_loan_records():
    """æ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„å€Ÿç”¨è®°å½•"""
    st.subheader("ğŸ“Š æˆ‘çš„å€Ÿç”¨è®°å½•")
    
    current_user_id = st.session_state.get('user_id')
    
    # è·å–å½“å‰ç”¨æˆ·çš„å€Ÿç”¨è®°å½•
    query = """
    SELECT 
        mlr.loan_id,
        m.mold_code,
        m.mold_name,
        mlr.application_timestamp,
        mlr.loan_out_timestamp,
        mlr.expected_return_timestamp,
        mlr.actual_return_timestamp,
        ls.status_name as loan_status,
        mlr.destination_equipment,
        u2.full_name as approver_name,
        mlr.remarks
    FROM mold_loan_records mlr
    JOIN molds m ON mlr.mold_id = m.mold_id
    JOIN loan_statuses ls ON mlr.loan_status_id = ls.status_id
    LEFT JOIN users u2 ON mlr.approver_id = u2.user_id
    WHERE mlr.applicant_id = %s
    ORDER BY mlr.application_timestamp DESC
    """
    
    my_records = execute_query(query, (current_user_id,))
    
    if not my_records:
        st.info("æ‚¨è¿˜æ²¡æœ‰å€Ÿç”¨è®°å½•")
        return
    
    # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    total_records = len(my_records)
    active_loans = len([r for r in my_records if r['loan_status'] == 'å·²é¢†ç”¨'])
    pending_loans = len([r for r in my_records if r['loan_status'] == 'å¾…å®¡æ‰¹'])
    
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("æ€»ç”³è¯·æ•°", total_records)
    with col2:
        st.metric("ä½¿ç”¨ä¸­", active_loans)
    with col3:
        st.metric("å¾…å®¡æ‰¹", pending_loans)
    
    # æ˜¾ç¤ºè®°å½•åˆ—è¡¨
    for record in my_records:
        # æ ¹æ®çŠ¶æ€è®¾ç½®ä¸åŒçš„æ ‡é¢˜é¢œè‰²
        status_emoji = {
            "å¾…å®¡æ‰¹": "ğŸ•",
            "å·²æ‰¹å‡†": "âœ…",
            "å·²é¢†ç”¨": "ğŸ”§",
            "å·²å½’è¿˜": "ğŸ“¥",
            "å·²é©³å›": "âŒ"
        }
        
        emoji = status_emoji.get(record['loan_status'], "ğŸ“‹")
        
        with st.expander(f"{emoji} {record['mold_code']} - {record['mold_name']} ({record['loan_status']})"):
            col1, col2 = st.columns(2)
            
            with col1:
                st.write(f"**ç”³è¯·æ—¶é—´ï¼š** {record['application_timestamp'].strftime('%Y-%m-%d %H:%M')}")
                if record['loan_out_timestamp']:
                    st.write(f"**å€Ÿå‡ºæ—¶é—´ï¼š** {record['loan_out_timestamp'].strftime('%Y-%m-%d %H:%M')}")
                if record['actual_return_timestamp']:
                    st.write(f"**å½’è¿˜æ—¶é—´ï¼š** {record['actual_return_timestamp'].strftime('%Y-%m-%d %H:%M')}")
                st.write(f"**ä½¿ç”¨è®¾å¤‡ï¼š** {record['destination_equipment']}")
            
            with col2:
                st.write(f"**é¢„è®¡å½’è¿˜ï¼š** {record['expected_return_timestamp'].strftime('%Y-%m-%d')}")
                st.write(f"**å½“å‰çŠ¶æ€ï¼š** {record['loan_status']}")
                if record['approver_name']:
                    st.write(f"**å®¡æ‰¹äººï¼š** {record['approver_name']}")
            
            if record['remarks']:
                st.write("**å¤‡æ³¨ï¼š**")
                st.text(record['remarks'])
            
            # å¦‚æœæ˜¯å·²é¢†ç”¨çŠ¶æ€ï¼Œæ˜¾ç¤ºå½’è¿˜æé†’
            if record['loan_status'] == 'å·²é¢†ç”¨':
                if record['expected_return_timestamp'].date() < datetime.now().date():
                    st.warning("âš ï¸ å·²è¶…è¿‡é¢„è®¡å½’è¿˜æ—¶é—´ï¼Œè¯·å°½å¿«å½’è¿˜")